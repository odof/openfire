<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!--##########################################################################################################################-->
    <!--###################################################______Service______####################################################-->
    <!--##########################################################################################################################-->

    <!-- Recalcul de la date de prochaine intervention lors du passage aux nouveaux plannings. -->
    <function model="of.service" name="function_set_date_next" />

    <!-- ### Services récurrents et ponctuels -->

    <record id="view_of_service_form" model="ir.ui.view">
        <field name="name">of.service.form</field>
        <field name="model">of.service</field>
        <field name="arch" type="xml">
            <form>
                <header>
                    <button name="button_valider" string="Valider" states="draft" type="object"/>
                    <button name="button_annuler" string="Annuler" type="object"
                            attrs="{'invisible': [('base_state', '!=', 'calculated')]}"/>
                    <button name="button_brouillon" string="Remettre en brouillon" states="cancel" type="object"/>
                    <button name="action_service_send" string="Envoyer par email" type="object"/>
                    <field name="kanban_step_id" widget="statusbar" clickable="True"/>
                </header>
                <sheet>
                    <field name="alert_dates" invisible="1"/>
                    <div class="oe_button_box" name="button_box">
                        <button name="action_view_saleorder"
                                type="object"
                                context="{'default_partner_id': partner_id}"
                                class="oe_stat_button"
                                icon="fa-usd">
                            <field name="saleorder_count" widget="statinfo" string="Ventes"/>
                        </button>
                        <button name="action_view_invoice"
                                type="object"
                                class="oe_stat_button"
                                icon="fa-usd">
                            <field name="invoice_count" widget="statinfo" string="Factures"/>
                        </button>
                        <button class="oe_stat_button" name="action_view_intervention" type="object" icon="fa-calendar">
                            <field string="RDVs Tech" name="intervention_count" widget="statinfo"/>
                        </button>
                        <button name="toggle_active" type="object"
                                class="oe_stat_button" icon="fa-archive"
                                confirm="Êtes-vous sûr de vouloir archiver/activer ce service ?">
                            <field name="active" widget="boolean_button"
                                options='{"terminology": "archive"}'/>
                        </button>
                    </div>
                    <div class="of_title">
                        <h1><b>
                            <field name="priority" class="oe_inline of_ws" widget="priority" nolabel="1"/>
                            <span class="of_ws" attrs="{'invisible': [('number', '!=', False)]}">
                                Demande d'intervention
                            </span>
                            <field name="number" readonly="1" class="oe_inline of_ws"/>
                            <span attrs="{'invisible': [('titre', '=', False)]}" class="of_ws">-</span>
                            <field name="titre" class="oe_inline" placeholder="Titre de la demande..."/>
                        </b></h1>
                    </div>
                    <group col="4">
                        <field name="state" invisible="1"/>
                        <field name="base_state" invisible="1"/>
                        <group col="2" colspan="2">
                            <field name="type_id" />
                            <field name="template_id" context="{'type_prio_id': type_id}"
                                   attrs="{'readonly': [('number', '!=', False), ('base_state', 'not in', ('draft', 'cancel'))]}"/>
                            <field name="order_id" context="{'extended_display': 1}" attrs="{'invisible': [('type_id','not in', [%(of_service.of_service_type_installation)d, %(of_service.of_service_type_maintenance)d])]}"/>
                            <field name="recurrence" attrs="{'invisible': [('type_id','not in',[%(of_service.of_service_type_maintenance)d])]}"/>
                        </group>
                        <group col="2" colspan="2">
                            <field name="user_id"/>
                            <field name="tag_ids" widget="many2many_tags"/>
                        </group>
                        <group name="who" col="2" colspan="2" string="Qui" class="of_grey_background">
                            <group colspan="2">
                                <field name="employee_ids" widget="many2many_tags"/>
                                <field name="company_id"/>
                            </group>
                        </group>
                        <group name="where" col="2" colspan="2" string="Où" class="of_grey_background">
                            <group colspan="2">
                                <field name="partner_id"/>
                                <field name="partner_tag_ids" widget="many2many_tags"/>
                                <label for="address_id" string="Adresse d'intervention"/>
                                <div class="o_address_format">
                                    <div><field name="address_id"/></div>
                                    <field name="address_street" class="o_address_street"/>
                                    <field name="address_street2" class="o_address_street"/>
                                    <field name="address_zip" class="o_address_zip of_ws"/>
                                    <field name="address_city" class="o_address_city"/>
                                    <div attrs="{'invisible': [('address_phone', '=', False)]}">
                                        <i class="fa fa-phone of_ws"/>
                                        <field name="address_phone"/>
                                    </div>
                                    <div attrs="{'invisible': [('address_mobile', '=', False)]}">
                                        <i class="fa fa-phone of_ws"/>
                                        <field name="address_mobile"/>
                                    </div>
                                </div>
                                <field name="secteur_tech_id"/>
                            </group>
                        </group>
                        <group name="what" col="2" colspan="2" string="Quoi" class="of_grey_background">
                            <group colspan="2">
                                <field name="tache_id"/>
                                <label for="duree" string="Durées"/>
                                <div>
                                    <field name="duree" widget="float_time" nolabel="1" class="oe_inline" attrs="{'invisible': [('state', '=', 'done')]}"/>
                                    <i class="oe_grey oe_inline" attrs="{'invisible': [('state', '=', 'done')]}"> estimée, dont </i>
                                    <field name="duree_planif" widget="float_time" nolabel="1" class="oe_inline" attrs="{'invisible': [('state', '=', 'done')]}"/>
                                    <i class="oe_grey oe_inline" attrs="{'invisible': [('state', '=', 'done')]}"> planifiée et </i>
                                    <field name="duree_restante" widget="float_time" nolabel="1" class="oe_inline" attrs="{'invisible': [('state', '=', 'done')]}"/>
                                    <i class="oe_grey oe_inline" attrs="{'invisible': [('state', '=', 'done')]}"> restante</i>
                                    <i class="oe_grey oe_inline" attrs="{'invisible': [('state', '!=', 'done')]}">
                                        Cette intervention est terminée
                                    </i>
                                </div>
                            </group>
                        </group>
                        <group name="when" col="2" colspan="2" string="Quand" class="of_grey_background">
                            <group colspan="2">
                                <field name="date_next" string="Entre le"/>
                                <field name="date_fin" string="et le"/>
                                <field name="jour_ids" widget="many2many_tags" options="{'no_create': True}"/>
                                <field name="mois_ids" widget="many2many_tags" options="{'no_create': True}" attrs="{'invisible': [('recurrence', '=', False)]}"/>
                                <label for="recurring_interval" attrs="{'invisible': [('recurrence', '=', False)]}"/>
                                <div attrs="{'invisible': [('recurrence', '=', False)]}" col="2">
                                    <field name="recurring_interval" nolabel="1" class="oe_inline of_ws"/>
                                    <field name="recurring_rule_type" nolabel="1" class="oe_inline"/>
                                </div>
                                <field name="recurrence_tache" invisible="1"/>
                            </group>
                        </group>
                    </group>
                    <notebook>
                        <page name="description" string="Description">
                            <group>
                                <field name="note" nolabel="1"/>
                            </group>
                        </page>
                        <page name="historique" string="Historique">
                            <group name="interventions" string="Interventions">
                                <field colspan="4" mode="tree" name="historique_interv_ids" nolabel="1"
                                       widget="one2many_list">
                                    <tree string="Interventions">
                                        <field name="employee_ids" widget="many2many_tags"/>
                                        <field name="type_id"/>
                                        <field name="tache_id"/>
                                        <field name="date" string="Date"/>
                                        <field name="duree" string="Durée"/>
                                        <field name="date_deadline" string="Date fin"/>
                                        <field name="state"/>
                                        <field name="name"/>
                                        <field name="description" string="Description"/>
                                    </tree>
                                </field>
                            </group>
                        </page>
                        <page name="facturation" string="Facturation">
                            <field name="currency_id" invisible="1"/>
                            <group>
                                <group>
                                    <field name="fiscal_position_id" options="{'no_create': True, 'no_open': True}"/>
                                </group>
                            </group>
                            <field name="line_ids">
                                <tree editable="bottom">
                                    <field name="product_id"/>
                                    <field name="name"/>
                                    <field name="qty"/>
                                    <field name="price_unit"/>
                                    <field name="taxe_ids" widget="many2many_tags"/>
                                    <field name="price_subtotal" readonly="1"/>
                                    <field name="price_total" readonly="1"/>
                                    <field name="so_number" string="CC"/>
                                </tree>
                            </field>
                            <group class="oe_subtotal_footer oe_right" colspan="2" name="intervention_total">
                                <field name="price_subtotal" widget="monetary"
                                       options="{'currency_field': 'currency_id'}"/>
                                <field name="price_tax" widget="monetary" options="{'currency_field': 'currency_id'}"/>
                                <div class="oe_subtotal_footer_separator oe_inline o_td_label">
                                    <label for="price_total"/>
                                </div>
                                <field name="price_total" nolabel="1" class="oe_subtotal_footer_separator"
                                       widget="monetary" options="{'currency_field': 'currency_id'}"/>
                            </group>
                        </page>
                    </notebook>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_follower_ids" widget="mail_followers"/>
                    <field name="message_ids" widget="mail_thread"/>
                </div>
            </form>
        </field>
    </record>

    <record id="of_service_kanban_view" model="ir.ui.view">
        <field name="name">of.service.kanban.view</field>
        <field name="model">of.service</field>
        <field name="arch" type="xml">
            <kanban class="o_kanban_small_column" default_group_by="kanban_step_id">
                <field name="type_id"/>
                <field name="kanban_step_id"/>
                <field name="date_next"/>
                <field name="date_fin"/>
                <field name="partner_id"/>
                <field name="address_id"/>
                <field name="address_address"/>
                <field name="spec_date"/>
                <templates>
                    <t t-name="kanban-box">
                        <div class="oe_kanban_card oe_kanban_global_click">
                            <div class="oe_kanban_content">
                                <div>
                                    <field name="tag_ids"/>
                                </div>
                                <strong class="oe_partner_heading"><field name="address_id"/> - <field name="type_id"/></strong>
                                <ul>
                                    <li t-if="record.address_address.raw_value"><field name="address_address"/></li>
                                    <br/>
                                    <li t-if="record.spec_date.raw_value"><field name="spec_date"/></li>
                                </ul>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- Service Map View -->
    <record id="of_service_map_view" model="ir.ui.view">
        <field name="name">of.service.map</field>
        <field name="model">of.service</field>
        <field name="arch" type="xml">
            <map string="Map" class="of_map_service" latitude_field="geo_lat" longitude_field="geo_lng" color_field="color">
                <field name="active" invisible="1"/>
                <field name="recurrence"/>
                <field name="color" required="1"/>
                <field name="geo_lat" required="1"/>
                <field name="geo_lng" required="1"/>
                <field name="precision" required="1"/>
                <field name="id"/>
                <field name="partner_name"/>
                <field name="tache_name"/>
                <field name="address_zip"/>
                <field name="address_city"/>
                <field name="partner_mobile"/>
                <field name="partner_phone"/>
                <field name="name"/>
                <field name="date_next"/>
                <templates>
                    <t t-name="of_map_record_box">
                        <div t-attf-class="#{map_record_color(record.color.raw_value)} of_map_record_global_click">
                            <div class="of_map_record_buttons">
                                <i class="of_map_record_close fa fa-lg fa-times"/>
                                <!--i class="of_map_record_min fa fa-lg fa-minus"/>  later implementation...
                                <i class="of_map_record_max fa fa-lg fa-square"/-->
                            </div>
                            <div name="content" class="of_map_record_content">
                                <t t-if="record.partner_name.raw_value">
                                    <i class="of_map_record_main fa fa-user"/><span class="of_ws"/><strong><field name="partner_name"/></strong>
                                    <t t-if="record.recurrence">
                                        <span class="of_ws"/>
                                        <i class="of_map_record_main fa fa-repeat"/>
                                    </t>
                                    <br/>
                                </t>
                                <t t-if="record.address_zip.raw_value">
                                    <i class="of_map_record_main fa fa-map-marker"/><span class="of_ws"/><field name="address_zip"/><span class="of_ws"/><field name="address_city"/><br/>
                                </t>
                                <t t-if="record.partner_phone.raw_value">
                                    <i class="of_map_record_main fa fa-phone"/><span class="of_ws"/><field name="partner_phone"/><br/>
                                </t>
                                <t t-if="record.partner_mobile.raw_value">
                                    <i class="of_map_record_main fa fa-phone"/><span class="of_ws"/><field name="partner_mobile"/><br/>
                                </t>
                                <t t-if="record.tache_name.raw_value">
                                    <i class="of_map_record_main fa fa-cogs"/><span class="of_ws"/><field name="tache_name"/><br/>
                                </t>
                                <t t-if="record.date_next.raw_value">
                                    <i class="of_map_record_main fa fa-truck"/><span class="of_ws"/><field name="date_next"/><br/>
                                </t>
                            </div>
                        </div>
                    </t>
                    <t t-name="of_map_marker_tooltip">
                        <div name="marker_tooltip">
                            <i class="fa fa-user"/><span class="of_ws"/>
                            <field name="partner_name"/><br/>
                            <t t-if="record.recurrence">
                                <i class="of_map_record_main fa fa-repeat"/>Service récurrent<br/>
                            </t>
                            <t t-else="">
                                Demande d'intervention<br/>
                            </t>
                            Précision:
                            <t t-if='["manual","high","medium","low"].includes(record.precision.raw_value)'>
                                <field name="precision"/>
                            </t>
                            <t t-else="">
                                <span class="of_ws"/>
                                Indeterminée
                            </t>
                        </div>
                    </t>
                </templates>
            </map>
        </field>
    </record>

    <record id="view_of_service_rec_tree" model="ir.ui.view">
        <field name="name">of.service.tree</field>
        <field name="model">of.service</field>
        <field name="arch" type="xml">
            <tree colors="grey:active==False;red:color=='red';orange:color=='orange';gray:color=='gray';blue:color=='blue'">
                <field name="color" invisible="1"/>
                <field name="active" invisible="1"/>
                <field name="partner_id"/>
                <field name="number"/>
                <field name="titre"/>
                <field name="address_zip"/>
                <field name="address_city"/>
                <field name="tache_id"/>
                <field name="recurrence"/>
                <field name="date_next" string="À partir du"/>
                <field name="date_fin" string="Au plus tard le"/>
                <field name="date_last"/>
                <field name="date_fin_contrat" string="Fin du contrat"/>
                <field name="note"/>
                <field name="tag_ids" widget="many2many_tags"/>
                <field name="state"/>
            </tree>
        </field>
    </record>

    <record id="view_of_service_filter" model="ir.ui.view">
        <field name="name">of.service.select</field>
        <field name="model">of.service</field>
        <field name="type">search</field>
        <field name="arch" type="xml">
            <search>
                <filter string="Récurrente" name="filter_rec" domain="[('recurrence', '=', True)]"/>
                <filter string="Ponctuelle" name="filter_ponc" domain="[('recurrence', '=', False)]"/>
                <separator/>
                <filter string="Entretien" name="filter_entretien"
                        domain="[('type_id', '=', %(of_service.of_service_type_maintenance)d)]"/>
                <filter string="Installation" name="filter_installation"
                        domain="[('type_id', '=', %(of_service.of_service_type_installation)d)]"/>
                <filter string="Visite technique" name="filter_vt"
                        domain="[('type_id', '=', %(of_service.of_service_type_technical)d)]"/>
                <separator/>
                <filter string="Brouillon" name="filter_draft" domain="[('state', '=', 'draft')]"/>

                <filter string="Semaine en cours" name="this_week"
                        domain="['|',
                                 '&amp;',
                                    ('recurrence', '=', True),
                                    ('state', '=', 'to_plan'),
                                 '&amp;',
                                    ('recurrence', '=', False),
                                    ('state_ponc', 'in', ('to_plan', 'part_planned')),
                                 ('date_fin', u'&gt;=', (context_today() - datetime.timedelta(days=context_today().weekday())).strftime('%Y-%m-%d')),
                                 ('date_next', u'&lt;', (context_today() + datetime.timedelta(days=7-context_today().weekday())).strftime('%Y-%m-%d')),
                                 ]"/>
                <filter string="Semaine prochaine" name="next_week"
                        domain="['|',
                                 '&amp;',
                                    ('recurrence', '=', True),
                                    ('state', '=', 'to_plan'),
                                 '&amp;',
                                    ('recurrence', '=', False),
                                    ('state_ponc', 'in', ('to_plan', 'part_planned')),
                                 ('date_fin', u'&gt;=', (context_today() + datetime.timedelta(days=7-context_today().weekday())).strftime('%Y-%m-%d')),
                                 ('date_next', u'&lt;', (context_today() + datetime.timedelta(days=14-context_today().weekday())).strftime('%Y-%m-%d')),
                                 ]"/>
                <filter string="Mois en cours" name="this_month"
                        domain="['|',
                                 '&amp;',
                                    ('recurrence', '=', True),
                                    ('state', '=', 'to_plan'),
                                 '&amp;',
                                    ('recurrence', '=', False),
                                    ('state_ponc', 'in', ('to_plan', 'part_planned')),
                                 ('date_fin', u'&gt;=', context_today().strftime('%Y-%m-01')),
                                 ('date_next', u'&lt;', (context_today() + relativedelta(day=1,months=1)).strftime('%Y-%m-%d')),
                                 ]"/>
                <filter string="Mois prochain" name="next_month"
                        domain="['|',
                                 '&amp;',
                                    ('recurrence', '=', True),
                                    ('state', '=', 'to_plan'),
                                 '&amp;',
                                    ('recurrence', '=', False),
                                    ('state_ponc', 'in', ('to_plan', 'part_planned')),
                                 ('date_fin', u'&gt;=', (context_today() + relativedelta(day=1,months=1)).strftime('%Y-%m-%d')),
                                 ('date_next', u'&lt;', (context_today() + relativedelta(day=1,months=2)).strftime('%Y-%m-%d')),
                                 ]"/>

                <filter string="En retard de planification" name="filter_late" domain="[('state', '=', 'late')]"/>
                <filter string="Terminé" name="filter_done" domain="[('state', '=', 'done')]"/>
                <filter string="Annulé" name="filter_cancel" domain="[('state', '=', 'cancel')]"/>
                <filter string="À planifier" name="filter_to_plan" domain="[('state', '=', 'to_plan')]"
                        invisible="1"/>
                <filter string="Planifié récemment" name="filter_planned" domain="[('state', '=', 'planned')]"
                        invisible="1"/>
                <filter string="Planifié prochainement" name="filter_planned_soon"
                        domain="[('state', '=', 'planned_soon')]" invisible="1"/>
                <filter string="Partiellement planifié" name="filter_part_planned"
                        domain="[('state', '=', 'part_planned')]" invisible="1"/>
                <filter string="Entièrement planifié" name="filter_all_planned"
                        domain="[('state', '=', 'all_planned')]" invisible="1"/>
                <filter string="En cours" name="filter_progress" domain="[('state', '=', 'progress')]"
                        invisible="1"/>
                <separator/>
                <filter string="Planification restante" name="filter_plan"
                        domain="[('duree_restante', '>', 0), ('state', 'in', ('to_plan', 'part_planned', 'late'))]"/>
                <separator/>
                <filter string="Actif" name="filter_active" domain="[('active', '=', True)]"/>
                <filter string="Archivé" name="filter_inactive" domain="[('active', '=', False)]"/>
                <separator/>
                <field name="date_next" filter_domain="[('date_next','&lt;=',self)]"
                      string="Prochaine planification min" context="{'date_next_max': self}"/>
                <field name="partner_id"/>
                <field name="number"/>
                <field name="titre"/>
                <field name="address_id"/>
                <field name="address_zip" string="CP"/>
                <field name="tache_id"/>
                <field name="tag_ids" widget="many2one"/>
                <field name="mois_ids"/>
                <field name="jour_ids"/>
                <field name="state"/>
                <field name="note"/>
                <field name="recurrence" invisible="1"/>
                <field name="date_fin" invisible="1"/>
                <field name="date_fin_min" filter_domain="[('date_fin','&gt;=',self)]"/>
                <field name="date_fin_max" filter_domain="[('date_fin','&lt;=',self)]"/>
            </search>
        </field>
    </record>

    <record id="of_service_distinct_type_search_view" model="ir.ui.view">
        <field name="name">of.service.distinct.type.search.view</field>
        <field name="model">of.service</field>
        <field name="inherit_id" ref="of_service.view_of_service_filter"/>
        <field name="mode">primary</field>
        <field name="arch" type="xml">
            <xpath expr="//separator[1]" position="replace"/>
            <xpath expr="//filter[@name='filter_entretien']" position="replace"/>
            <xpath expr="//filter[@name='filter_installation']" position="replace"/>
            <xpath expr="//filter[@name='filter_vt']" position="replace"/>
        </field>
    </record>

    <record id="of_service_pivot" model="ir.ui.view">
        <field name="name">of.service.pivot</field>
        <field name="model">of.service</field>
        <field name="arch" type="xml">
            <pivot string="Interventions" disable_linking="True">
                <field name="date_next" interval="month" type="row"/>
            </pivot>
        </field>
    </record>

    <record id="of_service_stage_form_view" model="ir.ui.view">
        <field name="name">of.service.stage.form.view</field>
        <field name="model">of.service.stage</field>
        <field name="arch" type="xml">
            <form>
                <sheet>
                    <group>
                        <group>
                            <field name="name"/>
                            <field name="sequence"/>
                        </group>
                        <group>
                            <field name="type_ids" widget="many2many_tags"/>
                        </group>
                    </group>
                </sheet>
            </form>
        </field>
    </record>

    <record id="of_service_stage_tree_view" model="ir.ui.view">
        <field name="name">of.service.stage.tree.view</field>
        <field name="model">of.service.stage</field>
        <field name="arch" type="xml">
            <tree>
                <field name="sequence" widget="handle"/>
                <field name="name"/>
            </tree>
        </field>
    </record>

    <!--##########################################################################################################################-->
    <!--#################################################________Actions_________#################################################-->
    <!--##########################################################################################################################-->

    <record id="action_of_service_prog_form_planning" model="ir.actions.act_window">
        <field name="name">Demandes d'intervention</field>
        <field name="type">ir.actions.act_window</field>
        <field name="res_model">of.service</field>
        <field name="view_type">form</field>
        <field name="view_mode">tree,kanban,map,form,pivot</field>
        <field name="search_view_id" ref="view_of_service_filter"/>
        <field name="context">{
            'search_default_this_week': 1,
            'search_default_next_week': 1,
            'search_default_filter_late': 1,
            'search_default_filter_plan': 1,
        }</field>
    </record>

    <!-- Générer devis depuis DI -->
    <record id="action_make_sale_order" model="ir.actions.server">
        <field name="name">Générer devis client</field>
        <field name="model_id" ref="of_service.model_of_service"/>
        <field name="state">code</field>
        <field name="code">action = obj.make_sale_order()</field>
    </record>
    <record id="value_make_sale_order" model="ir.values">
        <field name="name">Générer devis client</field>
        <field name="key2">client_action_multi</field>
        <field name="model">of.service</field>
        <field name="value" eval="'ir.actions.server,%d'%action_make_sale_order"/>
    </record>

    <record id="of_service_maintenance_action" model="ir.actions.act_window">
        <field name="name">Entretien - Maintenance</field>
        <field name="res_model">of.service</field>
        <field name="view_type">form</field>
        <field name="view_mode">tree,kanban,map,form,pivot</field>
        <field name="search_view_id" ref="of_service_distinct_type_search_view"/>
        <field name="domain" eval="[('type_id', '=', ref('of_service.of_service_type_maintenance'))]"/>
        <field name="context" eval="{'default_type_id': ref('of_service.of_service_type_maintenance'),
                                     'of_kanban_steps': 'Maintenance'}"/>
    </record>

    <record id="of_service_stage_action" model="ir.actions.act_window">
        <field name="name">Étapes de DI</field>
        <field name="res_model">of.service.stage</field>
        <field name="view_type">form</field>
        <field name="view_mode">tree,form</field>
        <field name="view_id" ref="of_service_stage_tree_view"/>
    </record>

    <!--##########################################################################################################################-->
    <!--#################################################_________Menus__________#################################################-->
    <!--##########################################################################################################################-->

    <menuitem id="menu_of_planning_service_prog" name="Demandes d'intervention" parent="of_planning.menu_of_planning_intervention"
              sequence="5" action="action_of_service_prog_form_planning"/>

    <menuitem id="of_service_maintenance_menu" name="Entretien - Maintenance" parent="of_planning.menu_of_planning_intervention"
              action="of_service_maintenance_action" sequence="10"/>

    <menuitem id="of_service_stage_menu" name="Étapes de DI" parent="of_planning.menu_of_planning_configuration_res"
              action="of_service_stage_action" sequence="90"/>

    <!--##########################################################################################################################-->
    <!--##################################################_______Taches_______####################################################-->
    <!--##########################################################################################################################-->

    <record id="of_planning_tache_view_form_service" model="ir.ui.view" >
        <field name="name">of.planning.tache.form.service</field>
        <field name="model">of.planning.tache</field>
        <field name="inherit_id" ref="of_planning.of_planning_tache_view_form"/>
        <field name="arch" type="xml" >
            <xpath expr="//div[@name='button_box']" position="inside">
                <button class="oe_stat_button" type="action"
                    name="%(action_of_service_prog_form_planning)d"
                    icon="fa-home"
                    context="{'search_default_tache_id': active_id}">
                    <field string="Interventions" name="service_count" widget="statinfo"/>
                </button>
            </xpath>
            <xpath expr="//field[@name='imp_detail']" position="after">
                <field name="recurrence"/>
                <label for="recurring_interval" attrs="{'invisible': [('recurrence', '=', False)]}"/>
                <div attrs="{'invisible': [('recurrence', '=', False)]}" col="2">
                    <field name="recurring_interval" nolabel="1" class="oe_inline of_ws"/>
                    <field name="recurring_rule_type" nolabel="1" class="oe_inline"/>
                </div>
            </xpath>
        </field>
    </record>

    <record id="of_planning_tache_view_tree_service" model="ir.ui.view" >
        <field name="name">of.planning.tache.tree.service</field>
        <field name="model">of.planning.tache</field>
        <field name="inherit_id" ref="of_planning.of_planning_tache_view_tree"/>
        <field name="arch" type="xml" >
            <xpath expr="//field[@name='category_id']" position="after">
                <field name="recurrence_display"/>
                <field name="recurrence" invisible="1"/>
                <field name="recurring_interval" invisible="1"/>
                <field name="recurring_rule_type" invisible="1"/>
            </xpath>
        </field>
    </record>

    <!--##########################################################################################################################-->
    <!--#################################################______Étiquettes______###################################################-->
    <!--##########################################################################################################################-->

    <record id="of_service_tag_view_form" model="ir.ui.view" >
        <field name="name">of.service.tag.form</field>
        <field name="model">of.service.tag</field>
        <field name="arch" type="xml" >
            <form>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button name="toggle_active" type="object"
                                class="oe_stat_button" icon="fa-archive">
                            <field name="active" widget="boolean_button"
                                options='{"terminology": "archive"}'/>
                        </button>
                    </div>
                    <div class="oe_title">
                        <label class="oe_edit_only" for="name" string="Nom"/>
                        <h1><field name="name" placeholder="nom de l'étiquette"/></h1>
                    </div>
                </sheet>
            </form>
        </field>
    </record>

    <record id="of_service_tag_view_tree" model="ir.ui.view" >
        <field name="name">of.service.tag.tree</field>
        <field name="model">of.service.tag</field>
        <field name="arch" type="xml">
            <tree string="Liste des Étiquettes" colors="grey: active == False">
                <field name="name"/>
                <field name="active" invisible="1"/>
            </tree>
        </field>
    </record>

    <!--##########################################################################################################################-->
    <!--##################################################______Planning______####################################################-->
    <!--##########################################################################################################################-->

    <record id="of_planning_intervention_filter_inh_service" model="ir.ui.view">
        <field name="name">of.planning.intervention.filter.service</field>
        <field name="model">of.planning.intervention</field>
        <field name="inherit_id" ref="of_planning.of_planning_intervention_filter"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='order_id']" position="after">
                <field name="service_id"/>
                <field name="type_id"/>
            </xpath>
        </field>
    </record>

    <record id="of_planning_intervention_view_form_service" model="ir.ui.view" >
        <field name="name">of.planning.intervention.form.service</field>
        <field name="model">of.planning.intervention</field>
        <field name="type">form</field>
        <field name="inherit_id" ref="of_planning.of_planning_intervention_view_form"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='template_id']" position="after">
                <field name="service_id" context="{
                'default_partner_id': partner_id,
                'default_address_id': address_id,
                'default_tache_id': tache_id,
                }"/>
            </xpath>
            <xpath expr="//field[@name='template_id']" position="attributes">
                <attribute name="context">{'type_prio_id': type_id}</attribute>
            </xpath>
            <xpath expr="//field[@name='tache_id']" position="before">
                <field name="type_id" attrs="{'readonly': [('service_id', '!=', False)]}"/>
            </xpath>
        </field>
    </record>

    <record id="of_service_of_planning_intervention_template_form_view" model="ir.ui.view">
        <field name="name">of.service.of.planning.intervention.template.form.view</field>
        <field name="model">of.planning.intervention.template</field>
        <field name="inherit_id" ref="of_planning.of_planning_intervention_template_view_form"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='tache_id']" position="before">
                <field name="type_id" options="{'no_open':True, 'no_create': True}"/>
            </xpath>
        </field>
    </record>

    <!--##########################################################################################################################-->
    <!--##################################################______sale.order______##################################################-->
    <!--##########################################################################################################################-->

    <!-- Action pour afficher la liste des demandes d'intervention -->
    <record id="of_sale_order_open_a_programmer" model="ir.actions.act_window">
        <field name="name">Demandes d'intervention</field>
        <field name="res_model">of.service</field>
        <field name="domain">[]</field> <!-- Force empty -->
        <field name="view_type">form</field>
    </record>

    <!-- Vue formulaire devis/commande :  ajout bouton "Demande d'intervention"-->
    <record id="sale_order_form_quote" model="ir.ui.view">
        <field name="name">sale.order.form.payment</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_order_form"/>
        <field name="arch" type="xml">
            <xpath expr="//header" position="inside">
                <button name="action_prevoir_intervention" string="Demande d'intervention" type="object"/>
            </xpath>
            <xpath expr="//div[@name='button_box']" position="inside">
                <button class="oe_stat_button" name="action_view_a_programmer" type="object" icon="fa-wrench">
                    <field string="Demande d'intervention" name="of_service_count" widget="statinfo"/>
                </button>
            </xpath>
        </field>
    </record>

    <!--##########################################################################################################################-->
    <!--##################################################______Partenaire______##################################################-->
    <!--##########################################################################################################################-->

    <record id="of_service_view_partner_form" model="ir.ui.view">
        <field name="name">of.service.view.partner.form</field>
        <field name="model">res.partner</field>
        <field name="type">form</field>
        <field name="inherit_id" ref="base.view_partner_form"/>
        <field name="arch" type="xml">
            <xpath expr="//header" position="inside">
                <button name="action_prevoir_intervention" string="Demande d'intervention" type="object"/>
            </xpath>
            <xpath expr="//form//div[@name='button_box']" position="inside">
                <button class="oe_stat_button" name="action_view_recurrent" type="object" icon="fa-wrench"
                  groups="of_planning.of_group_planning_intervention_lecture_tout">
                    <field string="DI récurrentes" name="recurrent_count" widget="statinfo"/>
                </button>
                <button class="oe_stat_button" name="action_view_a_programmer" type="object" icon="fa-wrench"
                  groups="of_planning.of_group_planning_intervention_lecture_tout">
                    <field string="DI à programmer" name="a_programmer_count" widget="statinfo"/>
                </button>
            </xpath>
            <page name="sales_purchases" position="after">
                <page string="Intervention" name="service" invisible="1">
                    <!-- Affichage des services liés au partenaire -->
                    <field name="service_partner_ids" nolabel="1" attrs="{'invisible': [('parent_id','!=', False)]}"
                           context="{'default_address_id':id}">
                        <tree string="Interventions" colors="grey:active==False">
                            <field name="address_id" domain="[('parent_id','=',parent.id)]"/>
                            <field name="tache_id"/>
                            <field name="mois_ids"/>
                            <field name="note"/>
                            <field name="date_last" string="Dernière"/>
                            <field name="date_next" string="Prochaine"/>
                            <field name="date_fin_contrat" string="Échéance"/>
                            <field name="active" invisible="1"/>
                        </tree>
                    </field>

                    <!-- Affichage des services liés à l'adresse -->
                    <field name="service_address_ids" nolabel="1" attrs="{'invisible': [('parent_id','=', False)]}"
                           context="{'hide_service_address_id':True}">
                        <tree string="Service" colors="grey:active==False">
                            <field name="tache_id"/>
                            <field name="mois_ids"/>
                            <field name="note"/>
                            <field name="active" invisible="1"/>
                            <field name="date_last" string="Dernière"/>
                            <field name="date_next" string="Prochaine"/>
                            <field name="date_fin_contrat" string="Échéance"/>
                            <field name="state" invisible="0"/>
                        </tree>
                    </field>
                </page>
            </page>
        </field>
    </record>

        <!-- Générer facture depuis DI -->
    <record id="action_of_create_invoice_service" model="ir.actions.server">
        <field name="name">Générer facture</field>
        <field name="model_id" ref="model_of_service"/>
        <field name="state">code</field>
        <field name="code">action = records.create_invoice()</field>
        <field name="groups">account.group_account_invoice</field>
    </record>

    <record id="action_create_invoice_service" model="ir.values">
        <field name="name">Générer facture</field>
        <field name="key2">client_action_multi</field>
        <field name="model">of.service</field>
        <field name="value" eval="'ir.actions.server,%d'%action_of_create_invoice_service"/>
        <field name="groups">account.group_account_invoice</field>
    </record>

</odoo>
