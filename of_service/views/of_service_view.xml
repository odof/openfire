<?xml version="1.0" encoding="utf-8"?>
<openerp>
    <data>


<!--##########################################################################################################################-->
<!--###################################################______Service______####################################################-->
<!--##########################################################################################################################-->

        <record id="view_of_service_form" model="ir.ui.view">
            <field name="name">of.service.form</field>
            <field name="model">of.service</field>
            <field name="arch" type="xml">
                <form>
                    <header></header>
                    <sheet>
                        <div class="oe_button_box" name="button_box">
                            <button name="toggle_active" type="object"
                                    class="oe_stat_button" icon="fa-archive"
                                    confirm="Êtes-vous sûr de vouloir archiver/activer ce service ?">
                                <field name="active" widget="boolean_button"
                                    options='{"terminology": "archive"}'/>
                            </button>
                        </div>
                        <div class="oe_title">
                            <separator string="Service"/>
                        </div>
                        <group>
                            <field name="partner_id" invisible="context.get('hide_service_partner_id')"/>
                            <field name="address_id" invisible="context.get('hide_service_address_id')"/>

                            <field name="tache_id"/>
                            <!-- <field name="template_id"/> -->
                            <field name="date_next"/>
                            <field name="date_fin"/>
                            <field name="mois_ids" widget="many2many_tags" options="{'no_create': True}"/>
                            <field name="jour_ids" widget="many2many_tags" options="{'no_create': True}"/>
                            <field name="note"/>
                        </group>
                        <notebook>
                            <page string="Interventions">
                                <field name="planning_ids" nolabel="1" colspan="2">
                                    <tree string="Liste des interventions" colors="darkolivegreen:state=='confirm';grey:state=='cancel';darkred:state=='postponed';darkblue:state=='done';purple:state=='unfinished'">
                                        <field name="name" string="Libellé"/>
                                        <field name="date"/>
                                        <field name="duree" string="Durée" widget="float_time"/>
                                        <field name="equipe_id"/>
                                        <field name="company_id"/>
                                        <field name="state"/>
                                        <field name="description"/>
                                    </tree>
                                </field>
                            </page>
                        </notebook>

                    </sheet>
                </form>
            </field>
        </record>

        <record id="view_res_partner_of_service_form" model="ir.ui.view">
            <field name="name">of.partner.service.form</field>
            <field name="model">of.service</field>
            <field name="priority" eval="10"/>
            <field name="arch" type="xml">
                <form>
                    <sheet>
                        <field name="active" invisible="1"/>
                        <group>
                            <field name="partner_id" invisible="1"/>
                            <field name="address_id" invisible="context.get('hide_service_address_id')"
                                   domain="['|',('id','=',parent.id),('parent_id','=',parent.id)]"/>
                            <separator string="Informations générales" colspan="2"/>
                            <field name="tache_id"/>
                            <!-- <field name="template_id"/> -->
                            <field name="date_next"/>
                            <field name="date_fin"/>
                            <field name="mois_ids" widget="many2many_tags" options="{'no_create': True}"/>
                            <field name="jour_ids" widget="many2many_tags" options="{'no_create': True}"/>
                        </group>
                        <separator string="Notes"/>
                        <field name="note"/>
                        <separator string="Interventions"/>
                        <field name="planning_ids" nolabel="1" colspan="2">
                            <tree string="Liste des interventions" colors="darkolivegreen:state=='confirm';grey:state=='cancel';darkred:state=='postponed';darkblue:state=='done';purple:state=='unfinished'">
                                <field name="name" string="Libellé"/>
                                <field name="date"/>
                                <field name="duree" string="Durée" widget="float_time"/>
                                <field name="equipe_id"/>
                                <field name="company_id"/>
                                <field name="state"/>
                                <field name="description"/>
                            </tree>
                        </field>
                    </sheet>
                </form>
            </field>
        </record>

        <record id="view_of_service_tree" model="ir.ui.view">
            <field name="name">of.service.tree</field>
            <field name="model">of.service</field>
            <field name="arch" type="xml">
                <tree colors="grey:active==False;red:color=='red';orange:color=='orange';gray:color=='gray';blue:color=='blue'">
                    <field name="color" invisible="1"/>
                    <field name="partner_id"/>
                    <field name="partner_zip"/>
                    <field name="partner_city"/>
                    <field name="tache_id"/>
                    <field name="mois_ids"/>
                    <field name="jour_ids"/>
                    <field name="note"/>
                    <!-- <field name="template_id"/> -->
                    <field name="date_last"/>
                    <field name="date_next"/>
                    <field name="date_fin"/>
                    <field name="active" invisible="1"/>
                    <!--field name="state" invisible="1"/-->
                </tree>
            </field>
        </record>

       <record id="view_of_service_filter" model="ir.ui.view">
            <field name="name">of.service.select</field>
            <field name="model">of.service</field>
            <field name="type">search</field>
            <field name="arch" type="xml">
               <search>
                   <filter string="En cours" name="filter_progress" domain="[('active', '=', True)]"/>
                   <filter string="Annulé" name="filter_cancel" domain="[('active', '=', False)]"/>
                   <field name="date_next" filter_domain="[('date_next','&lt;=',self)]"
                          string="Prochaine intervention min" context="{'date_next_max': self}"/>
                   <field name="partner_id"/>
                   <field name="address_id"/>
                   <field name="partner_zip" string="CP"/>
                   <field name="tache_id"/>
                   <field name="mois_ids"/>
                   <field name="jour_ids"/>
                   <field name="date_fin" invisible="1"/>
                   <field name="date_fin_min" filter_domain="[('date_fin','&gt;=',self)]"/>
                   <field name="date_fin_max" filter_domain="[('date_fin','&lt;=',self)]"/>
               </search>
            </field>
        </record>

        <!-- Service Map View -->
        <record id="of_service_map_view" model="ir.ui.view">
            <field name="name">of.service.map</field>
            <field name="model">of.service</field>
            <field name="arch" type="xml">
                <map string="Map" class="of_map_service" latitude_field="geo_lat" longitude_field="geo_lng" color_field="color">
                    <field name="active" invisible="1"/>
                    <field name="color" required="1"/>
                    <field name="geo_lat" required="1"/>
                    <field name="geo_lng" required="1"/>
                    <field name="precision" required="1"/>
                    <field name="id"/>
                    <field name="partner_name"/>
                    <field name="partner_zip"/>
                    <field name="partner_city"/>
                    <field name="partner_mobile"/>
                    <field name="name"/>
                    <field name="date_next"/>
                    <templates>
                        <t t-name="of_map_record_box">
                            <div t-attf-class="#{map_record_color(record.color.raw_value)} of_map_record_global_click">
                                <div class="of_map_record_buttons">
                                    <i class="of_map_record_close fa fa-lg fa-times"/>
                                    <!--i class="of_map_record_min fa fa-lg fa-minus"/>  later implementation...
                                    <i class="of_map_record_max fa fa-lg fa-square"/-->
                                </div>
                                <div name="content" class="of_map_record_content">
                                    <t t-if="record.partner_name.raw_value">
                                        <i class="of_map_record_main fa fa-user"/><span class="of_ws"/><strong><field name="partner_name"/></strong><br/>
                                    </t>
                                    <t t-if="record.partner_zip.raw_value">
                                        <i class="of_map_record_main fa fa-map-marker"/><span class="of_ws"/><field name="partner_zip"/><span class="of_ws"/><field name="partner_city"/><br/>
                                    </t>
                                    <t t-if="record.partner_mobile.raw_value">
                                        <i class="of_map_record_main fa fa-phone"/><span class="of_ws"/><field name="partner_mobile"/><br/>
                                    </t>
                                    <t t-if="record.name.raw_value">
                                        <i class="of_map_record_main fa fa-cogs"/><span class="of_ws"/><field name="name"/><br/>
                                    </t>
                                    <t t-if="record.date_next.raw_value">
                                        <i class="of_map_record_main fa fa-truck"/><span class="of_ws"/><field name="date_next"/><br/>
                                    </t>
                                </div>
                            </div>
                        </t>
                        <t t-name="of_map_marker_tooltip">
                            <div name="marker_tooltip">
                                <i class="fa fa-user"/><span class="of_ws"/>
                                <field name="partner_name"/><br/>
                                Précision:
                                <t t-if='["manual","high","medium","low"].includes(record.precision.raw_value)'>
                                    <field name="precision"/>
                                </t>
                                <t t-else="">
                                    <span class="of_ws"/>
                                    Indeterminée
                                </t>
                            </div>
                        </t>
                    </templates>
                </map>
            </field>
        </record>

<!--##########################################################################################################################-->
<!--##################################################______Planning______####################################################-->
<!--##########################################################################################################################-->

<!--##########################################################################################################################-->
<!--##################################################______Partenaire______##################################################-->
<!--##########################################################################################################################-->

       <record id="of_service_view_partner_form" model="ir.ui.view">
            <field name="name">of.service.view.partner.form</field>
            <field name="model">res.partner</field>
            <field name="type">form</field>
            <field name="inherit_id" ref="base.view_partner_form"/>
            <field name="arch" type="xml">
                <page name="sales_purchases" position="after">
                    <page string="Service" name="service">
                        <!-- Affichage des services liés au partenaire -->
                        <field name="service_partner_ids" nolabel="1" attrs="{'invisible': [('parent_id','!=', False)]}"
                               context="{'default_address_id':id}">
                            <tree string="Service" colors="grey:active==False">
                                <field name="address_id" domain="[('parent_id','=',parent.id)]"/>
                                <field name="tache_id"/>
                                <field name="mois_ids"/>
                                <field name="note"/>
                                <!-- <field name="template_id"/> -->
                                <field name="date_last" string="Dernière"/>
                                <field name="date_next" string="Prochaine"/>
                                <field name="date_fin" string="Échéance"/>
                                <field name="active" invisible="1"/>
                                <!--field name="state" invisible="0"/-->
                                <!--button name="% (of_gesdoc.action_view_courrier_wizard)d" icon="gtk-paste" string="Ajouter Contrat" type="action"
                                        attrs="{'invisible': [('template_id', '=', False)]}"/-->
                            </tree>
                        </field>

                        <!-- Affichage des services liés à l'adresse -->
                        <field name="service_address_ids" nolabel="1" attrs="{'invisible': [('parent_id','=', False)]}"
                               context="{'hide_service_address_id':True}">
                            <tree string="Service" colors="grey:active==False">
                                <field name="tache_id"/>
                                <field name="mois_ids"/>
                                <field name="note"/>
                                <field name="active" invisible="1"/>
                                <!-- <field name="template_id"/> -->
                                <field name="date_last" string="Dernière"/>
                                <field name="date_next" string="Prochaine"/>
                                <field name="date_fin" string="Échéance"/>
                                <field name="state" invisible="0"/>
                                <!--button name="% (of_gesdoc.action_view_courrier_wizard)d" icon="gtk-paste" string="Ajouter Contrat" type="action"
                                        attrs="{'invisible': [('template_id', '=', False)]}"/-->
                            </tree>
                        </field>
                    </page>
                </page>
            </field>
        </record>

<!--##########################################################################################################################-->
<!--#################################################________Actions_________#################################################-->
<!--##########################################################################################################################-->

        <record id="action_of_service_form" model="ir.actions.act_window">
            <field name="name">Services</field>
            <field name="type">ir.actions.act_window</field>
            <field name="res_model">of.service</field>
            <field name="view_type">form</field>
            <field name="view_mode">tree,map,form</field>
        </record>

        <record id="action_service_tree_view" model="ir.actions.act_window.view">
            <field eval="0" name="sequence"/>
            <field name="view_mode">tree</field>
            <field name="view_id" ref="view_of_service_tree"/>
            <field name="act_window_id" ref="action_of_service_form"/>
        </record>

        <record id="action_service_map_view" model="ir.actions.act_window.view">
            <field eval="1" name="sequence"/>
            <field name="view_mode">map</field>
            <field name="view_id" ref="of_service_map_view"/>
            <field name="act_window_id" ref="action_of_service_form"/>
        </record>

        <record id="action_service_form_view" model="ir.actions.act_window.view">
            <field name="sequence" eval="2"/>
            <field name="view_mode">form</field>
            <field name="view_id" ref="view_of_service_form"/>
            <field name="act_window_id" ref="action_of_service_form"/>
        </record>

<!--##########################################################################################################################-->
<!--#################################################_________Menus__________#################################################-->
<!--##########################################################################################################################-->

        <menuitem id="menu_of_service" name="Services" parent="sales_team.menu_sales" sequence="105" action="action_of_service_form"/>
        <menuitem id="menu_of_planning_service" name="Services" parent="of_planning.menu_of_planning_intervention" sequence="25" action="action_of_service_form"/>

    </data>
</openerp>
