<?xml version="1.0"?>
<odoo>

    <!--*****************************************************************************************-->
    <!--**************************************** Project ****************************************-->
    <!--*****************************************************************************************-->

    <record id="of_project_planning_project_kanban_view" model="ir.ui.view">
        <field name="name">of_project_planning.project.kanban.view</field>
        <field name="model">project.project</field>
        <field name="inherit_id" ref="of_project.of_project_project_kanban_view"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='name']" position="before">
                <field name="of_total_planned_hours"/>
                <field name="of_total_done_hours"/>
                <field name="of_ressources"/>
            </xpath>
            <xpath expr="//div[@class='o_kanban_primary_left']" position="inside">
                <div style="margin-top: 10px;">
                    <span style="display: flex;">Durée prévue :<field name="of_total_planned_hours" widget="float_time"/></span>
                    <span style="display: flex;">Durée réalisée :<field name="of_total_done_hours" widget="float_time"/></span>
                </div>
                <div style="margin-top: 10px;">
                    <t t-value="JSON.parse(record.of_ressources.raw_value)" t-set="ressources"/>
                    <t t-foreach="ressources" t-as="ressource">
                        <img t-att-src="kanban_image('res.users', 'image_small', ressource['id'])"
                             t-attf-title="#{ressource['name']}" width="24" height="24"
                             class="oe_kanban_avatar pull-left"/>
                    </t>
                </div>
            </xpath>
        </field>
    </record>

    <!--*****************************************************************************************-->
    <!--******************************************Project Task***********************************-->
    <!--*****************************************************************************************-->

    <record id="of_project_planning_of_project_project_task_form_view" model="ir.ui.view">
        <field name="name">of_project_planning.of_project.project.task.form.view</field>
        <field name="model">project.task</field>
        <field name="inherit_id" ref="of_project.of_project_project_task_form_view"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='of_participant_ids']" position="attributes">
                <attribute name="invisible">1</attribute>
            </xpath>
        </field>
    </record>

    <record id="of_project_planning_of_project_project_task_kanban_view" model="ir.ui.view">
        <field name="name">of_project_planning.of_project.project.task.kanban.view</field>
        <field name="model">project.task</field>
        <field name="inherit_id" ref="of_project.of_project_project_task_kanban_view"/>
        <field name="arch" type="xml">
            <xpath expr="//img[@t-att-name='participant_ids']" position="attributes">
                <attribute name="invisible">1</attribute>
            </xpath>
        </field>
    </record>

    <record id="of_project_planning_view_task_form2_inherited" model="ir.ui.view">
        <field name="name">of_project_planning.view.task.form2.inherited</field>
        <field name="model">project.task</field>
        <field name="inherit_id" ref="hr_timesheet.view_task_form2_inherited"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='planned_hours']" position="attributes">
                <attribute name="readonly">1</attribute>
            </xpath>
            <xpath expr="//page[@name='description_page']" position="after">
                <page name="planning_page" string="Planification">
                    <field name="of_planning_ids">
                        <tree editable="bottom">
                            <field name="type_id"/>
                            <field name="user_id"/>
                            <field name="period_id"/>
                            <field name="duration"/>
                            <field name="notes"/>
                        </tree>
                    </field>
                </page>
            </xpath>
        </field>
    </record>

    <record id="of_project_planning_project_task_kanban_view" model="ir.ui.view">
        <field name="name">of_project_planning.project.task.kanban.view</field>
        <field name="model">project.task</field>
        <field name="inherit_id" ref="project.view_task_kanban"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='user_id']" position="replace">
                <field name="of_ressources"/>
            </xpath>
            <xpath expr="//div[@class='oe_kanban_bottom_right']/img" position="replace">
                <t t-value="JSON.parse(record.of_ressources.raw_value)" t-set="ressources"/>
                <t t-foreach="ressources" t-as="ressource">
                    <img t-att-src="kanban_image('res.users', 'image_small', ressource['id'])"
                         t-attf-title="#{ressource['name']}" width="24" height="24"
                         class="oe_kanban_avatar pull-right"/>
                </t>
            </xpath>
         </field>
     </record>

    <record id="of_project_planning_project_task_search_view" model="ir.ui.view">
        <field name="name">of_project_planning.project.task.search.view</field>
        <field name="model">project.task</field>
        <field name="inherit_id" ref="of_project.of_project_project_task_search_view"/>
        <field name="arch" type="xml">
            <xpath expr="//filter[@name='product_projects']" position="after">
                <separator/>
                <filter string="Planifiée cette semaine" name="this_week"
                        domain="[(u'of_periode_ids.dernier_jour', u'>=', (context_today() - datetime.timedelta(days=context_today().weekday())).strftime('%Y-%m-%d')),
                                 (u'of_periode_ids.premier_jour', u'&lt;', (context_today() + datetime.timedelta(days=7-context_today().weekday())).strftime('%Y-%m-%d'))]"/>
                <filter string="Planifiée la semaine dernière" name="last_week"
                        domain="[(u'of_periode_ids.dernier_jour', u'>=', (context_today() - datetime.timedelta(days=context_today().weekday()+7)).strftime('%Y-%m-%d')),
                                 (u'of_periode_ids.premier_jour', u'&lt;', (context_today() - datetime.timedelta(days=context_today().weekday())).strftime('%Y-%m-%d'))]"/>
                <filter string="Planifiée la semaine prochaine" name="next_week"
                        domain="[(u'of_periode_ids.dernier_jour', u'>=', (context_today() + datetime.timedelta(days=7-context_today().weekday())).strftime('%Y-%m-%d')),
                                 (u'of_periode_ids.premier_jour', u'&lt;', (context_today() + datetime.timedelta(days=14-context_today().weekday())).strftime('%Y-%m-%d'))]"/>
                <separator/>
                <filter string="Planifiée ce mois" name="this_month"
                        domain="[(u'of_periode_ids.dernier_jour', u'>=', context_today().strftime('%Y-%m-01')),
                                 (u'of_periode_ids.premier_jour', u'&lt;', (context_today() + relativedelta(day=1,months=1)).strftime('%Y-%m-%d'))]"/>
                <filter string="Planifiée le mois dernier" name="last_month"
                        domain="[(u'of_periode_ids.dernier_jour', u'>=', (context_today() - relativedelta(day=1,months=1)).strftime('%Y-%m-%d')),
                                 (u'of_periode_ids.premier_jour', u'&lt;', context_today().strftime('%Y-%m-01'))]"/>
                <filter string="Planifiée le mois prochain" name="next_month"
                        domain="[(u'of_periode_ids.dernier_jour', u'>=', (context_today() + relativedelta(day=1,months=1)).strftime('%Y-%m-%d')),
                                 (u'of_periode_ids.premier_jour', u'&lt;', (context_today() + relativedelta(day=1,months=2)).strftime('%Y-%m-%d'))]"/>
            </xpath>
            <xpath expr="//group" position="inside">
                <filter string="Période(s)" name="groupby_period" domain="[]" context="{'group_by':'of_gb_period_id'}"/>
            </xpath>
            <xpath expr="//field[@name='user_id']" position="attributes">
                <attribute name="filter_domain">['|',('user_id', '=', self),('of_planning_ids.user_id', '=', self)]</attribute>
            </xpath>
        </field>
    </record>

</odoo>
