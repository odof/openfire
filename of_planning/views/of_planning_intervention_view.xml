<?xml version="1.0" encoding="utf-8"?>
<odoo>

<!--##############################################################################-->
<!--########################### ______ Employés ______ ###########################-->
<!--##############################################################################-->

    <!--Hr Employee inherit search view-->
    <record id="hr_employee_view_search_in_planning" model="ir.ui.view">
        <field name="name">hr.employee.search.view.inherit.planning</field>
        <field name="model">hr.employee</field>
        <field name="inherit_id" ref="hr.view_employee_filter"/>
        <field name="arch" type="xml">
            <!-- Ajout filtre Intervenants -->
            <xpath expr="//filter[@name='inactive']" position="after">
                <filter name="intervenants" string="Intervenants" domain="[('of_est_intervenant', '=', True)]"/>
                <filter name="commerciaux" string="Commerciaux" domain="[('of_est_commercial', '=', True)]"/>
            </xpath>
        </field>
    </record>

    <!-- Employee -->
    <record id="view_of_employee_form_intervention" model="ir.ui.view">
        <field name="name">of.hr.employee.form.intervention</field>
        <field name="model">hr.employee</field>
        <field name="inherit_id" ref="hr.view_employee_form"/>
        <field name="arch" type="xml">
            <!-- Ajout champ of_est_intervenant -->
            <xpath expr="//field[@name='job_id']" position="after">
                <field name="of_est_intervenant"/>
                <field name="of_est_commercial"/>
            </xpath>
            <!-- Ajout onglet interventions -->
            <xpath expr="//notebook" position="inside">
                <page name="interventions" string="Interventions"
                      attrs="{'invisible': [('of_est_intervenant', '=', False), ('of_est_commercial', '=', False)]}">
                    <group>
                        <group name="gauche_1" string="Planning">
                            <field name="of_equipe_ids" widget="many2many_tags"/>
                            <field name="of_impression_planning"/>
                            <field name="of_daily_email"/>
                        </group>
                        <group name="droite_1"/>
                    </group>
                    <group string="Tâches" name="tache">
                        <field name="of_toutes_taches"/>
                        <label for="of_tache_ids" colspan="2"
                               attrs="{'invisible': [('of_toutes_taches', '=', True)]}"/>
                        <field name="of_tache_ids" widget="many2many" nolabel="1" colspan="2"
                               attrs="{'invisible': [('of_toutes_taches', '=', True)]}"/>
                    </group>
                </page>
            </xpath>
        </field>
    </record>

<!--##########################################################################################################################-->
<!--#############################################______Historique du client______#############################################-->
<!--##########################################################################################################################-->

    <record id="of_planning_view_partner_form" model="ir.ui.view">
        <field name="name">of.planning.partner.form</field>
        <field name="model">res.partner</field>
        <field name="inherit_id" ref="of_base.of_base_partner_form"/>
        <field name="arch" type="xml">
            <!-- Ajout smart button RDVs Tech -->
            <xpath expr="//form//div[@name='button_box']" position="inside">
                <button class="oe_stat_button" name="action_view_intervention" type="object" icon="fa-calendar"
                  groups="of_planning.group_planning_intervention_modification">
                    <field string="RDVs Tech" name="intervention_count" widget="statinfo"/>
                </button>
            </xpath>
            <!-- Ajout onglet historique avec les RDV Tech partenaire et Adresse -->
            <page name="historique" position="inside">
                <field name="id" invisible="1"/>
                <group name="histo_interventions" string="Interventions">
                    <field name="intervention_partner_ids" colspan="4" nolabel="1" attrs="{'invisible': [('parent_id','!=', False)]}"
                           context="{'form_view_ref':'of_planning.of_planning_intervention_view_form2',
                                     'force_read': True}">
                        <tree string="Plannings">
                            <field name="tache_id"/>
                            <field name="employee_ids" widget="many2many_tags"/>
                            <field name="date" string="Date"/>
                            <field name="duree" string="Durée" widget="float_time"/>
                            <field name="state"/>
                            <field name="name" string="Libellé"/>
                            <field name="description" string="Description"/>
                        </tree>
                    </field>
                    <field name="intervention_address_ids" colspan="4" nolabel="1" attrs="{'invisible': [('parent_id','=', False)]}"
                            context="{'form_view_ref':'of_planning.of_planning_intervention_view_form2', 'default_address_id':id,
                                      'force_read': True}">
                        <tree string="Plannings">
                            <field name="employee_ids" widget="many2many_tags"/>
                            <field name="tache_id"/>
                            <field name="date" string="Date"/>
                            <field name="duree" string="Durée" widget="float_time"/>
                            <field name="state"/>
                            <field name="name" string="Libellé"/>
                            <field name="description" string="Description"/>
                            <field name="category_id"/>
                        </tree>
                    </field>
                </group>
            </page>
        </field>
    </record>

<!--##########################################################################################################################-->
<!--############################################______Planning d'intervention______###########################################-->
<!--##########################################################################################################################-->

<!--##################################################______Recherche______###################################################-->
    <record id="of_planning_intervention_filter" model="ir.ui.view">
        <field name="name">of.planning.intervention.filter</field>
        <field name="model">of.planning.intervention</field>
        <field name="arch" type="xml">
            <search string="Recherche">
                <group name="filter">
                    <filter string="Brouillon" name="state_draft" icon="terp-folder-violet" domain="[('state','=','draft')]"/>
                    <filter string="Confirmé" name="state_confirm" icon="gtk-no" domain="[('state','=','confirm')]"/>
                    <filter string="Réalisé" name="state_done" icon="terp-folder-blue" domain="[('state','=','done')]"/>
                    <filter string="Inachevé" name="state_unfinished" icon="terp-folder-blue" domain="[('state','=','unfinished')]"/>
                    <filter string="Annulé" name="state_cancel" icon="terp-dialog-close-red" domain="[('state','=','cancel')]"/>
                    <filter string="Reporté" name="state_postponed" icon="terp-folder-green" domain="[('state','=','postponed')]"/>
                    <separator/>
                    <filter string="Clôturé" name="closed" domain="[('closed', '=', True)]"/>
                    <filter string="Non clôturé" name="opened" domain="[('closed', '=', False)]"/>
                    <separator/>
                    <filter string="Semaine en cours" name="this_week"
                            domain="[('date_deadline', u'&gt;=', (context_today() - datetime.timedelta(days=context_today().weekday())).strftime('%Y-%m-%d')),
                                     ('date', u'&lt;', (context_today() + datetime.timedelta(days=7-context_today().weekday())).strftime('%Y-%m-%d'))]"/>
                    <filter string="Semaine prochaine" name="next_week"
                            domain="[('date_deadline', u'&gt;=', (context_today() + datetime.timedelta(days=7-context_today().weekday())).strftime('%Y-%m-%d')),
                                     ('date', u'&lt;', (context_today() + datetime.timedelta(days=14-context_today().weekday())).strftime('%Y-%m-%d'))]"/>
                    <filter string="Mois en cours" name="this_month"
                            domain="[('date_deadline', u'&gt;=', context_today().strftime('%Y-%m-01')),
                                     ('date', u'&lt;', (context_today() + relativedelta(day=1,months=1)).strftime('%Y-%m-%d'))]"/>
                    <filter string="Mois prochain" name="next_month"
                            domain="[('date_deadline', u'&gt;=', (context_today() + relativedelta(day=1,months=1)).strftime('%Y-%m-%d')),
                                     ('date', u'&lt;', (context_today() + relativedelta(day=1,months=2)).strftime('%Y-%m-%d'))]"/>
                    <filter string="Hier" name="yesterday"
                            domain="[(u'date', u'&gt;=', (context_today() - datetime.timedelta(days=1)).strftime('%Y-%m-%d')),
                                     (u'date', u'&lt;', context_today().strftime('%Y-%m-%d'))]"/>
                    <filter string="Aujourd'hui" name="today"
                            domain="[(u'date', u'&gt;=', current_date),
                                     (u'date', u'&lt;', (context_today() + datetime.timedelta(days=1)).strftime('%Y-%m-%d'))]"/>
                    <filter string="Demain" name="tomorrow"
                            domain="[(u'date', u'&gt;=', (context_today() + datetime.timedelta(days=1)).strftime('%Y-%m-%d')),
                                     (u'date', u'&lt;', (context_today() + datetime.timedelta(days=2)).strftime('%Y-%m-%d'))]"/>
                    <separator/>
                    <filter string="Rien à facturer" name="no" domain="[('invoice_status', '=', 'no')]"/>
                    <filter string="À facturer" name="invoiceable" domain="[('invoice_status', '=', 'to invoice')]"/>
                    <filter string="Entièrement facturée" name="invoiced" domain="[('invoice_status', '=', 'invoiced')]"/>
                </group>
                <newline/>
                <group name="field">
                    <field name="name" filter_domain="['|', ('name','ilike',self), ('number','ilike',self)]"/>
                    <field name="date_date"/>
                    <field name="date_date" string="Semaine intervention"
                           context="{'of_date_search_mode':'week'}"/>
                    <field name="date_date" string="Mois intervention"
                           context="{'of_date_search_mode':'month'}"/>
                    <field name="duree"/>
                    <field name="tag_ids" widget="many2one"/>
                    <field name="user_id" widget="selection"/>
                    <field name="tache_id" widget="selection"/>
                    <field name="category_id" widget="selection"/>
                    <field name="equipe_id" widget="selection"/>
                    <field name="employee_ids"/>
                    <field name="address_id"/>
                    <field name="order_id"/>
                    <field name="company_id" widget="selection"/>
                </group>
                <newline/>
                <group expand="0" string="Regrouper par..." name="group_by">
                   <filter string="Utilisateur" icon="terp-personal" domain="[]" context="{'group_by' : 'user_id'}"/>
                   <filter string="Tâche" icon="terp-folder-blue" domain="[]" context="{'group_by' : 'tache_id'}"/>
                   <filter string="Équipe" icon="terp-partner" domain="[]" context="{'group_by' : 'equipe_id'}"/>
                   <filter string="Intervenant" icon="terp-partner" domain="[]" context="{'group_by' : 'gb_employee_id'}"/>
                   <filter string="Magasin" icon="terp-go-home" domain="[]" context="{'group_by' : 'company_id'}"/>
               </group>
                <newline/>
                <group expand="0" string="Recherche avancée">
                    <field name="id"/>
                    <field name="description"/>
                    <field name="raison_id"/>
                </group>
             </search>
        </field>
    </record>

    <record id="of_planning_intervention_filter_flexibility" model="ir.ui.view">
        <field name="name">of.planning.intervention.filter.flexibility</field>
        <field name="model">of.planning.intervention</field>
        <field name="groups_id" eval="[(6,0,[ref('of_planning.of_group_planning_intervention_flexibility')])]" />
        <field name="inherit_id" ref="of_planning.of_planning_intervention_filter"/>
        <field name="arch" type="xml">
            <xpath expr="//group[@name='filter']" position="inside">
                <separator/>
                <filter string="RDVs flexibles" name="flexible" domain="[('flexible', '=', True)]"/>
                <filter string="RDVs fixes" name="fixed" domain="[('flexible', '=', False)]"/>
            </xpath>
        </field>
    </record>

<!--###################################################______Vue form______###################################################-->

    <record id="of_planning_intervention_view_form" model="ir.ui.view" >
        <field name="name">of.planning.intervention.form</field>
        <field name="model">of.planning.intervention</field>
        <field name="arch" type="xml" >
            <form string="Nouveau RDV d'intervention">
                <header>
                    <field name="closed" invisible="1"/>
                    Passer à
                    <button name="button_confirm" string="Confirmé" states="draft" type="object"/>
                    <button name="button_done" string="Réalisé" states="confirm" type="object"/>
                    <button name="button_unfinished" string="Inachevé" states="confirm" type="object"/>
                    <button name="button_postponed" string="Reporté" states="confirm" type="object"/>
                    <button name="button_cancel" string="Annulé" states="draft,confirm" type="object"/>
                    <button name="button_draft" string="Brouillon" states="confirm,done,unfinished,cancel,postponed" type="object"/>
                    <button name="action_intervention_send" string="Envoyer par email" type="object"/>
                    <button name="button_close" string="Clôturer" type="object" attrs="{'invisible': [('closed', '=', True)]}"/>
                    <button name="button_open" string="Ré-ouvrir" type="object" attrs="{'invisible': [('closed', '=', False)]}"/>
                    <field name="state" widget="statusbar" nolabel="1" statusbar_visible="draft,confirm,done"/>
                    <div align="right" style="align:right;padding: 0px 18px 0px 0px;width:100%">
                        <field name="raison_id" widget="selection" attrs="{'invisible':[('state', '!=', 'postponed')]}"/>
                    </div>
                </header>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button name="action_view_invoice"
                                type="object"
                                class="oe_stat_button"
                                icon="fa-pencil-square-o"
                                attrs="{'invisible': [('invoice_count', '=', 0)]}">
                            <field name="invoice_count" widget="statinfo" string="Factures"/>
                        </button>
                        <button type="object"
                                name="action_view_delivery"
                                class="oe_stat_button"
                                icon="fa-truck"
                                attrs="{'invisible': [('delivery_count', '=', 0)]}" groups="base.group_user">
                            <field name="delivery_count" widget="statinfo" string="Livraison"/>
                        </button>
                    </div>
                    <div class="oe_title" name="num">
                        <h1><b>
                            <span class="of_title of_ws">Rendez-vous d'intervention</span>
                            <field name="number" placeholder="N° d'intervention" readonly="1" nolabel="1" class="oe_inline"/>
                            <div class="label label-info" attrs="{'invisible': [('closed', '=', False)]}">Cloturé</div>
                        </b></h1>
                    </div>
                    <field name="alert_hors_creneau" invisible="1"/>
                    <field name="alert_incapable" invisible="1"/>
                    <field name="alert_coherence_date" invisible="1"/>
                    <field name="alert_wrong_company" invisible="1"/>
                    <group name="main">
                        <group>
                            <field name="template_id" attrs="{'readonly': [('number', '!=', False), ('state', 'not in', ('draft', 'cancel'))]}"/>
                            <field name="flexible" attrs="{'readonly': [('state','in',['done'])]}" groups="of_planning.of_group_planning_intervention_flexibility"/>
                        </group>
                        <group>
                            <field name="user_id"/>
                            <field name="order_user_id" attrs="{'invisible': [('order_id','=',False)]}"/>
                            <field name="tag_ids" widget="many2many_tags"/>
                        </group>
                        <group name="who" string="Qui" class="of_grey_background">
                            <group colspan="2">
                                <field name="equipe_id" autofocus="autofocus"/>
                                <label for="employee_ids" string="Intervenants"/>
                                <div>
                                    <field name="employee_ids" string="Intervenants" widget="many2many_tags"
                                           options='{"no_open": True, "no_create": True}'
                                           context="{'tache_prio_id': tache_id}"/>
                                    <div attrs="{'invisible': [('alert_incapable', '=', False)]}" class="of_red">
                                        <i class="fa fa-warning of_ws"/>Aucun intervenant ne peut réaliser cette tâche
                                    </div>
                                    <div attrs="{'invisible': [('alert_wrong_company', '=', False)]}" class="of_red">
                                        <i class="fa fa-warning of_ws"/>Au moins un des intervenants n'a pas accès à la société de ce RDV, il ne pourra donc pas l'éditer.'
                                    </div>
                                </div>
                                <field name="company_id" options="{'no_create': True, 'no_edit': True}"/>
                            </group>
                        </group>
                        <group name="where" string="Où" class="of_grey_background">
                            <group colspan="2">
                                <field name="partner_id"/>
                                <field name="partner_tag_ids" widget="many2many_tags"/>
                                <label for="address_id"/>
                            <div class="o_address_format">
                                <div><field name="address_id" domain="[('customer','=',True)]"/></div>
                                <field name="address_street"/>
                                <span attrs="{'invisible': ['|', ('address_street', '=', False), ('address_street2', '=', False)]}"> - </span>
                                <field name="address_street2"/><br/>
                                <field name="address_zip"/>
                                <span attrs="{'invisible': ['|', ('address_zip', '=', False), ('address_city', '=', False)]}"> - </span>
                                <field name="address_city"/><br/>
                                <field name="address_mobile"/>
                                <span attrs="{'invisible': ['|', ('address_mobile', '=', False), ('address_phone', '=', False)]}"> - </span>
                                <field name="address_phone"/>
                            </div>
                                <field name="secteur_id"/>
                                <field name="name"/>
                            </group>
                        </group>
                        <group name="what" string="Quoi" class="of_grey_background">
                            <group colspan="2">
                                <field name="tache_id" context="{'intervenant_prio_ids': employee_ids}"/>
                                <field name="duree" string="Durée" widget="float_time"/>
                            </group>
                        </group>
                        <group name="when" string="Quand" class="of_grey_background">
                            <group colspan="2">
                                <field name="all_day"/>
                                <label name="debut_label" for="date"/>
                                <div name="debut_value">
                                    <field name="jour" class="oe_inline of_ws"/>
                                    <field name="date" class="oe_inline"/>
                                </div>
                                <label name="fin_label" for="date_deadline" attrs="{'invisible': [('forcer_dates', '=', True)]}"/>
                                <div name="fin_value" attrs="{'invisible': [('forcer_dates', '=', True)]}">
                                    <field name="jour_fin" class="oe_inline of_ws"
                                           attrs="{'invisible': [('alert_hors_creneau', '=', True)]}"/>
                                    <field name="date_deadline" class="oe_inline"
                                           attrs="{'invisible': [('alert_hors_creneau', '=', True)]}"/>
                                    <div attrs="{'invisible': [('alert_hors_creneau', '=', False)]}" class="of_red">
                                        <i class="fa fa-warning of_ws"/>L'horaire de début des travaux est en dehors des heures de travail.
                                    </div>
                                </div>
                                <field name="horaire_du_jour" attrs="{'invisible': [('alert_hors_creneau', '=', False)]}"/>
                                <label name="fin_force_label" for="date_deadline_forcee"
                                       attrs="{'invisible': [('forcer_dates', '=', False)]}"/>
                                <div name="fin_force_value" attrs="{'invisible': [('forcer_dates', '=', False)]}">
                                    <field name="jour_fin_force" class="oe_inline of_ws"/>
                                    <field name="date_deadline_forcee" class="oe_inline"
                                           attrs="{'required': [('forcer_dates', '=', True)]}"/>
                                    <div attrs="{'invisible': ['|', ('alert_coherence_date', '=', False), ('all_day', '=', True)]}"
                                         class="of_red">
                                        <i class="fa fa-warning of_ws"/>
                                        la date de fin doit être au moins égale à la date de début + la durée
                                    </div>
                                    <div attrs="{'invisible': ['|', ('alert_coherence_date', '=', False), ('all_day', '=', False)]}"
                                         class="of_red">
                                        <i class="fa fa-warning of_ws"/>
                                        la durée est trop longue considérant les date de début et de fin
                                    </div>
                                </div>
                                <field name="forcer_dates"/>
                                <field name="verif_dispo"/>
                            </group>
                        </group>
                    </group>
                    <notebook>
                        <page name="infos" string="Informations">
                            <group col="4">
                                <group colspan="2" name="origin" string="Origine">
                                    <field name="order_id" context="{'extended_display': 1}"
                                    groups="sales_team.group_sale_salesman,
                                            account.group_account_invoice,
                                            stock.group_stock_user"/>
                                    <!-- widget many2many_tags car sinon le picking_domain[0][2] ne fonctionne pas
                                        (dans le domain du champ picking_manual_ids) -->
                                    <field name="picking_domain" invisible="1" widget="many2many_tags"
                                           context="{'force_read': True}"/>
                                    <field name="picking_manual_ids" mode="tree" string="Bons de livraison"
                                           groups="sales_team.group_sale_salesman, account.group_account_invoice, stock.group_stock_user"
                                           context="{'default_partner_id': address_id}">
                                        <tree>
                                            <field name="name"/>
                                            <field name="state" invisible="1"/>
                                            <button type="object" name="button_open_picking_manual" string="Ouvrir" icon="fa-external-link"/>
                                        </tree>
                                    </field>
                                </group>
                                <group colspan="2" name="misc" string="Divers">
                                </group>
                                <separator colspan="4" string="Description"/>
                                <div colspan="4"><h4><span>Description interne</span></h4></div>
                                <field name="description_interne" colspan="4" nolabel="1"/>
                                <div colspan="4"><h4><span>Description externe</span></h4></div>
                                <field name="description" colspan="4" nolabel="1"/>
<!--                                <h4 name="old_desc_title">Ancienne description</h4>-->
<!--                                <field name="old_description" nolabel="1" colspan="2"/>-->
                                <!-- Notes client -->
                                <group attrs="{'invisible':[('of_notes_client','=',False)]}">
                                    <separator string="Notes client" colspan="2"/>
                                    <field name="of_notes_client" colspan="2" nolabel="1" readonly="1"
                                           help="Ces notes proviennent de la fiche client sous la rubrique 'Notes internes'. Ils sont uniquement modifiables dans la fiche client."/>
                                </group>
                                <!-- Notes intervention -->
                                <group attrs="{'invisible':[('of_notes_intervention','=',False)]}">
                                    <separator string="Notes intervention" colspan="2"/>
                                    <field name="of_notes_intervention" nolabel="1"
                                           help="Ces notes proviennent du devis / commande sous la rubrique 'Notes intervention'. Ils sont uniquement modifiables dans le  devis / commande (voir la commande associée)."/>
                                </group>
                            </group>
                        </page>
                        <page name="facturation" string="Facturation">
                            <field name="lien_commande" invisible="1"/>
                            <field name="currency_id" invisible="1"/>
                            <group>
                                <group>
                                    <field name="do_deliveries" invisible="1"/>
                                    <field name="warehouse_id" attrs="{'invisible': [('do_deliveries', '=', False)]}" options="{'no_create': True, 'no_open': True}"/>
                                    <field name="invoice_policy"/>
                                    <field name="fiscal_position_id" attrs="{'readonly': [('lien_commande', '!=', False)]}" options="{'no_create': True, 'no_open': True}"/>
                                </group>
                                <group>
                                    <field name="partner_pricelist_id" groups="product.group_sale_pricelist"/>
                                </group>
                                <div class="oe_button_box">
                                    <button name="button_import_order_line" string="Importer"
                                            type="object"
                                            attrs="{'invisible': [('order_id','=',False)]}"
                                            class="oe_right btn-default"/>
                                    <button name="button_update_lines" string="Mettre à jour"
                                            type="object"
                                            attrs="{'invisible': [('order_id','=',False)]}"
                                            class="oe_right btn-default"/>
                                </div>
                            </group>
                            <field name="line_ids">
                                <tree editable="bottom" colors="blue:invoice_status=='to invoice';">
                                    <field name="order_line_id" invisible="1"/>
                                    <field name="invoice_status" invisible="1"/>
                                    <field name="product_id" attrs="{'readonly': [('order_line_id', '!=', False)]}"/>
                                    <field name="name" attrs="{'readonly': [('order_line_id', '!=', False)]}"/>
                                    <field name="qty"/>
                                    <field name="qty_delivered" readonly="1"/>
                                    <field name="qty_invoiced" readonly="1"/>
                                    <field name="price_unit" attrs="{'readonly': [('order_line_id', '!=', False)]}"/>
                                    <field name="taxe_ids" attrs="{'readonly': [('order_line_id', '!=', False)]}"
                                           widget="many2many_tags"/>
                                    <field name="price_subtotal" readonly="1"/>
                                    <field name="price_total" readonly="1"/>
                                    <field name="so_number" string="CC"/>
                                </tree>
                            </field>
                            <group class="oe_subtotal_footer oe_right" colspan="2" name="intervention_total">
                                <field name="price_subtotal" widget="monetary" options="{'currency_field': 'currency_id'}"/>
                                <field name="price_tax" widget="monetary" options="{'currency_field': 'currency_id'}"/>
                                <div class="oe_subtotal_footer_separator oe_inline o_td_label">
                                    <label for="price_total"/>
                                </div>
                                <field name="price_total" nolabel="1" class="oe_subtotal_footer_separator" widget="monetary" options="{'currency_field': 'currency_id'}"/>
                            </group>
                        </page>
                        <page name="payments" string="Paiements">
                            <group>
                                <group>
                                    <field name="order_amount_total"/>
                                    <field name="order_still_due"/>
                                    <field name="picking_amount_total"/>
                                </group>
                            </group>
                        </page>
                    </notebook>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_follower_ids" widget="mail_followers"/>
                    <field name="message_ids" widget="mail_thread"/>
                </div>
            </form>
        </field>
    </record>

    <record id="of_planning_intervention_view_form2" model="ir.ui.view" >
        <field name="name">of.planning.intervention.form2</field>
        <field name="model">of.planning.intervention</field>
        <field name="mode">primary</field>
        <field name="inherit_id" ref="of_planning.of_planning_intervention_view_form"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='address_id']" position="attributes">
                <attribute name="domain">['&amp;', ('customer', '=', True), '|', ('id', '=', parent.id), ('parent_id', '=', parent.id)]</attribute>
            </xpath>
        </field>
    </record>

<!--###################################################______Vue tree______###################################################-->

    <record id="of_planning_intervention_view_tree" model="ir.ui.view" >
        <field name="name">of.planning.intervention.tree</field>
        <field name="model">of.planning.intervention</field>
        <field name="arch" type="xml" >
            <tree string="Liste des interventions" colors="darkolivegreen:state=='confirm';grey:state=='cancel';darkred:state=='postponed';darkblue:state=='done';purple:state=='unfinished'">
                <field name="name" string="Libellé"/>
                <field name="user_id" invisible="1"/>
                <field name="date"/>
                <field name="date_deadline" string="Deadline" invisible="1"/>
                <field name="duree" string="Durée" widget="float_time"/>
                <field name="employee_ids" widget="many2many_tags"/>
                <field name="tache_id"/>
                <field name="address_id"/>
                <field name="address_city"/>
                <field name="company_id"/>
                <field name="state"/>
                <field name="tag_ids" widget="many2many_tags"/>
                <field name="description" string="Description"/>
            </tree>
        </field>
    </record>

<!--#############################################______Vue calendar_______#####################################################-->

    <record id="of_planning_intervention_view_calendar" model="ir.ui.view">
        <field name="name">of.planning.intervention.calendar</field>
        <field name="model">of.planning.intervention</field>
        <field name="arch" type="xml">
            <calendar string="Calendrier" date_start="date_prompt" color="employee_ids" attendee="employee_ids"
                      date_stop="date_deadline_prompt" display_states="1" quick_add="0" attendee_model="hr.employee"
                      color_ft_field="of_color_ft" color_bg_field="of_color_bg" custom_colors="1" color_is_attendee="1"
                      color_multiple="1" show_all_attendees="1" config_model="of.intervention.settings"
                      all_day="all_day">
                <field name="calendar_name"/>
                <field name="state" invisible="1"/>
                <field name="name" invisible="1"/>
                <field name="mobile" invisible="1"/>
                <field name="phone" invisible="1"/>
                <field name="tache_id" invisible="1"/>
                <field name="tache_categ_id" invisible="1"/>
                <field name="state_int" invisible="1"/>
                <field name="of_color_ft" invisible="1"/>
                <field name="of_color_bg" invisible="1"/>
                <field name="duree" invisible="1"/>
                <field name="heure_debut_str" invisible="1"/>
                <field name="heure_fin_str" invisible="1"/>
                <field name="tache_name" invisible="1"/>
                <field name="partner_name" invisible="1"/>
                <field name="address_zip" invisible="1"/>
                <field name="address_city" invisible="1"/>
                <field name="secteur_id" invisible="1"/>
            </calendar>
        </field>
    </record>

    <record id="of_planning_intervention_view_calendar_flexibility" model="ir.ui.view">
        <field name="name">of.planning.intervention.calendar.flexibility</field>
        <field name="model">of.planning.intervention</field>
        <field name="groups_id" eval="[(6,0,[ref('of_planning.of_group_planning_intervention_flexibility')])]" />
        <field name="inherit_id" ref="of_planning.of_planning_intervention_view_calendar"/>
        <field name="arch" type="xml">
            <xpath expr="//calendar" position="inside">
                <field name="flexible" icon="exchange" invisible="1" position="bot-right"/>
            </xpath>
        </field>
    </record>

    <!-- Vue calendrier avec saut au dernier RDV en date -->
    <record id="of_planning_intervention_view_calendar_with_jump" model="ir.ui.view">
        <field name="name">of.planning.intervention.calendar</field>
        <field name="model">of.planning.intervention</field>
        <field name="arch" type="xml">
            <calendar string="Calendrier" date_start="date_prompt" color="employee_ids" attendee="employee_ids"
                      date_stop="date_deadline_prompt" display_states="1" quick_add="0" attendee_model="hr.employee"
                      color_ft_field="of_color_ft" color_bg_field="of_color_bg" custom_colors="1"
                      color_is_attendee="1" jump_to="last" all_day="all_day" config_model="of.intervention.settings"
                      show_all_attendees="1">
                <field name="calendar_name"/>
                <field name="tache_id" invisible="1"/>
                <field name="name" invisible="1"/>
                <field name="mobile" invisible="1"/>
                <field name="phone" invisible="1"/>
                <field name="tache_categ_id" invisible="1"/>
                <field name="state" invisible="1"/>
                <field name="state_int" invisible="1"/>
                <field name="of_color_ft" invisible="1"/>
                <field name="of_color_bg" invisible="1"/>
            </calendar>
        </field>
    </record>

<!--#############################################______Vue pivot_______#####################################################-->


    <record id="of_planning_intervention_pivot" model="ir.ui.view">
        <field name="name">of.planning.intervention.pivot</field>
        <field name="model">of.planning.intervention</field>
        <field name="arch" type="xml">
            <pivot string="RDV d'intervention" disable_linking="True">
                <field name="employee_main_id" type="col"/>
                <field name="date" interval="month" type="row"/>
            </pivot>
        </field>
    </record>

<!--#############################################______Vue map_______#####################################################-->


    <record id="of_planning_intervention_map_view" model="ir.ui.view">
        <field name="name">of.planning.intervention.map.view</field>
        <field name="model">of.planning.intervention</field>
        <field name="arch" type="xml">
            <map latitude_field="geo_lat" longitude_field="geo_lng" color_field="color_map">
                <field name="color_map" required="1"/>
                <field name="geo_lat" required="1"/>
                <field name="geo_lng" required="1"/>
                <field name="partner_name"/>
                <field name="tache_name"/>
                <field name="address_zip"/>
                <field name="address_city"/>
                <field name="partner_mobile"/>
                <field name="partner_phone"/>
                <field name="date"/>
                <templates>
                    <t t-name="of_map_record_box">
                        <div t-attf-class="#{map_record_color(record.color_map.raw_value)} of_map_record_global_click">
                            <div class="of_map_record_buttons">
                                <i class="of_map_record_close fa fa-lg fa-times"/>
                            </div>
                            <div name="content" class="of_map_record_content">
                                <t t-if="record.partner_name.raw_value">
                                    <i class="of_map_record_main fa fa-user"/><span class="of_ws"/><strong><field name="partner_name"/></strong>
                                    <br/>
                                </t>
                                <t t-if="record.address_zip.raw_value">
                                    <i class="of_map_record_main fa fa-map-marker"/><span class="of_ws"/><field name="address_zip"/><span class="of_ws"/><field name="address_city"/><br/>
                                </t>
                                <t t-if="record.partner_phone.raw_value">
                                    <i class="of_map_record_main fa fa-phone"/><span class="of_ws"/><field name="partner_phone"/><br/>
                                </t>
                                <t t-if="record.partner_mobile.raw_value">
                                    <i class="of_map_record_main fa fa-phone"/><span class="of_ws"/><field name="partner_mobile"/><br/>
                                </t>
                                <t t-if="record.tache_name.raw_value">
                                    <i class="of_map_record_main fa fa-cogs"/><span class="of_ws"/><field name="tache_name"/><br/>
                                </t>
                                <t t-if="record.date.raw_value">
                                    <i class="of_map_record_main fa fa-truck"/><span class="of_ws"/><field name="date"/><br/>
                                </t>
                            </div>
                        </div>
                    </t>
                    <t t-name="of_map_marker_tooltip">
                        <div name="marker_tooltip">
                            <t t-if="record.partner_name.raw_value">
                                <i class="fa fa-user"/><span class="of_ws"/><field name="partner_name"/><br/>
                            </t>
                            <t t-if="record.address_zip.raw_value or record.address_city.raw_value">
                                <i class="fa fa-map-marker"/><span class="of_ws"/><field name="address_zip"/><span class="of_ws"/><field name="address_city"/><br/>
                            </t>
                            <t t-if="record.partner_phone.raw_value">
                                <i class="fa fa-phone"/><span class="of_ws"/><field name="partner_phone"/><br/>
                            </t>
                            <t t-if="record.partner_mobile.raw_value">
                                <i class="fa fa-phone"/><span class="of_ws"/><field name="partner_mobile"/><br/>
                            </t>
                            <t t-if="record.tache_name.raw_value">
                                <i class="fa fa-cogs"/><span class="of_ws"/><field name="tache_name"/><br/>
                            </t>
                            <t t-if="record.date.raw_value">
                                <i class="fa fa-truck"/><span class="of_ws"/><field name="date"/><br/>
                            </t>
                        </div>
                    </t>
                </templates>
            </map>
        </field>
    </record>


<!--##########################################################################################################################-->
<!--###########################################_Facturation d'intervention_###################################################-->
<!--##########################################################################################################################-->

<!--###################################################______Vue form______###################################################-->

        <record id="of_planning_intervention_line_view_form" model="ir.ui.view" >
            <field name="name">of.planning.intervention.line.form</field>
            <field name="model">of.planning.intervention.line</field>
            <field name="arch" type="xml" >
                <form string="Ligne facturable">
                    <group>
                        <group>
                            <field name="order_line_id" invisible="1"/>
                            <field name="company_id" invisible="1"/>
                            <field name="currency_id" invisible="1"/>
                            <field name="product_id"/>
                            <field name="qty"/>
                            <field name="price_unit"/>
                        </group>
                        <separator string="Description" name="s_description"/>
                        <field name="name" nolabel="1"/>
                    </group>
                </form>
            </field>
        </record>

<!--##########################################################################################################################-->
<!--###########################################_________Étiquettes_________###################################################-->
<!--##########################################################################################################################-->

<!--#############################################_______Recherche_________#####################################################-->
    <record id="of_planning_tag_filter" model="ir.ui.view">
        <field name="name">of.planning.tag.filter</field>
        <field name="model">of.planning.tag</field>
        <field name="arch" type="xml">
            <search string="Recherche">
                <field name="name"/>
                <separator/>
                <filter string="Active" name="active" domain="[('active','=',True)]"/>
                <filter string="Archivée" name="inactive" domain="[('active','=',False)]"/>
            </search>
        </field>
    </record>

<!--#############################################_______Vue form_________#####################################################-->

    <record id="of_planning_tag_view_form" model="ir.ui.view" >
        <field name="name">of.planning.tag.form</field>
        <field name="model">of.planning.tag</field>
        <field name="arch" type="xml" >
            <form>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button name="toggle_active" type="object"
                                class="oe_stat_button" icon="fa-archive">
                            <field name="active" widget="boolean_button"
                                options='{"terminology": "archive"}'/>
                        </button>
                    </div>
                    <div class="oe_title">
                        <label class="oe_edit_only" for="name" string="Nom"/>
                        <h1><field name="name" placeholder="nom de l'étiquette"/></h1>
                    </div>
                </sheet>
            </form>
        </field>
    </record>

<!--#############################################_______Vue tree_________#####################################################-->

    <record id="of_planning_tag_view_tree" model="ir.ui.view" >
        <field name="name">of.planning.tag.tree</field>
        <field name="model">of.planning.tag</field>
        <field name="arch" type="xml" >
            <tree string="Liste des Étiquettes" colors="grey: active == False">
                <field name="sequence" widget="handle"/>
                <field name="name" string="Libellé"/>
                <field name="active" invisible="1"/>
            </tree>
        </field>
    </record>

<!--##########################################################################################################################-->
<!--#############################################_________Tâches_________#####################################################-->
<!--##########################################################################################################################-->

<!--#############################################_______Recherche_________#####################################################-->
    <record id="of_planning_tache_filter" model="ir.ui.view">
        <field name="name">of.planning.tache.filter</field>
        <field name="model">of.planning.tache</field>
        <field name="arch" type="xml">
            <search string="Recherche">
                <group>
                    <field name="name"/>
                    <field name="is_crm"/>
                </group>
                <newline/>
                <group expand="0" string="Recherche avancée">
                    <field name="id"/>
                    <field name="description"/>
                </group>
             </search>
        </field>
    </record>

<!--#############################################_______Vue form_________#####################################################-->

    <record id="of_planning_tache_view_form" model="ir.ui.view" >
        <field name="name">of.planning.tache.form</field>
        <field name="model">of.planning.tache</field>
        <field name="arch" type="xml" >
            <form class="oe_form_configuration">
                <header></header>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button name="toggle_active" type="object"
                                class="oe_stat_button" icon="fa-archive"
                                confirm="Êtes-vous sûr de vouloir archiver/activer cette tâche ?">
                            <field name="active" widget="boolean_button"
                                options='{"terminology": "archive"}'/>
                        </button>
                    </div>
                    <div class="oe_title">
                        <label for="name" string="Libellé" class="oe_edit_only" attrs="{'readonly':[('verr', '=', True)]}"/>
                        <h1>
                            <field name="name"/>
                        </h1>
                    </div>
                    <notebook>
                        <page name="description" string="Description">
                            <group>
                                <group>
                                        <field  name="product_id" string="Produit lié" attrs="{'readonly':[('verr', '=', True)]}"/>
                                        <field name="tache_categ_id" options="{'no_create':True, 'no_open': True}"/>
                                        <field name="category_id"/>
                                        <field name="duree" widget="float_time"/>
                                        <field name="fiscal_position_id"/>
                                    </group>
                                <group>
                                    <field name="flexible" groups="of_planning.of_group_planning_intervention_flexibility"/>
                                    <field name="is_crm"/>
                                    <field name="imp_detail"/>
                                </group>
                                <group colspan="2">
                                    <field name="description" attrs="{'readonly':[('verr', '=', True)]}"/>
                                </group>
                                <group>
                                    <field name="affichage"/>
                                </group>
                                <field name="verr" invisible="1"/>
                            </group>
                        </page>
                    </notebook>
                </sheet>
            </form>
        </field>
    </record>

    <record id="of_planning_tache_categ_view_form" model="ir.ui.view" >
        <field name="name">of.planning.tache.categ.form</field>
        <field name="model">of.planning.tache.categ</field>
        <field name="arch" type="xml" >
            <form class="oe_form_configuration">
                <header></header>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button name="toggle_active" type="object"
                                class="oe_stat_button" icon="fa-archive"
                                confirm="Êtes-vous sûr de vouloir archiver/activer cette tâche ?">
                            <field name="active" widget="boolean_button"
                                options='{"terminology": "archive"}'/>
                        </button>
                    </div>
                    <div class="oe_title">
                        <label for="name" string="Libellé" class="oe_edit_only" attrs="{'readonly':[('verr', '=', True)]}"/>
                        <h1>
                            <field name="name"/>
                        </h1>
                    </div>
                    <group>
                        <group>
                            <field name="fourchette_planif"/>
                            <field name="color_ft" widget="color"/>
                            <field name="color_bg" widget="color"/>
                        </group>
                        <group>
                            <field name="sequence"/>
                        </group>
                        <label for="tache_ids" colspan="2"/>
                        <field name="tache_ids" widget="many2many" colspan="2" nolabel="1"/>
                    </group>
                </sheet>
            </form>
        </field>
    </record>

<!--#############################################_______Vue tree_________#####################################################-->

    <record id="of_planning_tache_categ_view_tree" model="ir.ui.view" >
        <field name="name">of.planning.tache.categ.tree</field>
        <field name="model">of.planning.tache.categ</field>
        <field name="arch" type="xml" >
            <tree string="Liste des catégories de tâches" >
                <field name="sequence" widget="handle"/>
                <field name="name" string="Libellé"/>
                <field name="color_bg" string="couleur" widget="color"/>
                <field name="tache_ids"/>
                <field name="description"/>
            </tree>
        </field>
    </record>

    <record id="of_planning_tache_view_tree" model="ir.ui.view" >
        <field name="name">of.planning.tache.tree</field>
        <field name="model">of.planning.tache</field>
        <field name="arch" type="xml" >
            <tree string="Liste des tâches" >
                <field name="sequence" widget="handle"/>
                <field name="name" string="Libellé"/>
                <field name="tache_categ_id" string="Catégorie"/>
                <field name="product_id"/>
                <field name="category_id"/>
                <field name="duree" widget="float_time"/>
                <field name="description"/>
            </tree>
        </field>
    </record>

<!--##########################################################################################################################-->
<!--##############################################________Equipes________#####################################################-->
<!--##########################################################################################################################-->

<!--#############################################_______Recherche_________#####################################################-->

    <record id="of_planning_equipe_filter" model="ir.ui.view">
        <field name="name">of.planning.equipe.filter</field>
        <field name="model">of.planning.equipe</field>
        <field name="arch" type="xml">
            <search string="Recherche">
                <group>
                    <filter name="filter_active" string="Désactivée" icon="terp-accessories-archiver" domain="[('active', '=', 0)]"/>
                    <field name="employee_ids"/>
                    <field name="name"/>
                    <field name="note"/>
                    <field name="category_ids"/>
                </group>
             </search>
        </field>
    </record>

<!--#############################################_______Vue tree_________#####################################################-->

    <record id="view_of_planning_equipe_tree" model="ir.ui.view">
        <field name="name">of.planning.equipe.tree</field>
        <field name="model">of.planning.equipe</field>
        <field name="arch" type="xml">
            <tree string="Liste des equipes" >
                <field name="name" string="Equipe"/>
                <field name="employee_ids"/>
                <field name="note"/>
                <field name="sequence"/>
            </tree>
        </field>
    </record>

<!--#############################################_______Vue form_________#####################################################-->

    <record id="view_of_planning_equipe_form" model="ir.ui.view">
        <field name="name">of.planning.equipe.form</field>
        <field name="model">of.planning.equipe</field>
        <field name="arch" type="xml">
            <form class="oe_form_configuration">
                <sheet>
                    <div class="oe_button_box" name="button_box" >
                        <!-- Bouton Actif -->
                        <button name="toggle_active" type="object" class="oe_stat_button" icon="fa-archive" display="inline-block">
                            <field name="active" widget="boolean_button" options='{"terminology": "archive"}'/>
                        </button>
                    </div>
                    <div class="oe_title">
                        <label for="name" string="Equipe" class="oe_edit_only"/>
                        <h1>
                            <field name="name"/>
                        </h1>
                    </div>
                    <group name="gr_1">
                        <group>
                            <field name="employee_ids" widget="many2many_tags"/>
                            <field name="sequence"/>
                        </group>
                        <field name="note" nolabel="1"/>
                    </group>
                </sheet>
            </form>
        </field>
    </record>

<!--#############################################_______Raisons inacheve reporte________#####################################################-->

    <record id="of_planning_intervention_raison_form" model="ir.ui.view">
        <field name="name">of.planning.intervention.raison.form</field>
        <field name="model">of.planning.intervention.raison</field>
        <field name="arch" type="xml">
            <form string="Raison">
                <group>
                    <field name="name" string="Libellé"/>
                </group>
            </form>
        </field>
    </record>

    <record id="of_planning_intervention_raison_tree" model="ir.ui.view">
        <field name="name">of.planning.intervention.raison.tree</field>
        <field name="model">of.planning.intervention.raison</field>
        <field name="arch" type="xml">
            <tree string="Raison">
                <field name="name" string="Libellé"/>
            </tree>
        </field>
    </record>

<!--##########################################################################################################################-->
<!--#############################################________Actions_________#####################################################-->
<!--##########################################################################################################################-->

    <record id="action_of_planning_intervention_calendar" model="ir.actions.act_window">
        <field name="name">Planning d'intervention</field>
        <field name="res_model">of.planning.intervention</field>
        <field name="view_type">form</field>
        <field name="view_mode">calendar,form,tree,pivot,map</field>
        <field name="context">
            {'search_default_state_confirm':1,
            'search_default_state_done':1,
            'search_default_state_draft':1,
            'search_default_state_unfinished':1}
        </field>
        <field name="view_id" ref="of_planning_intervention_view_calendar"/>
        <field name="search_view_id" ref="of_planning_intervention_filter"/>
    </record>

    <record id="action_of_planning_intervention_form" model="ir.actions.act_window">
        <field name="name">Planning d'intervention</field>
        <field name="res_model">of.planning.intervention</field>
        <field name="view_type">form</field>
        <field name="view_mode">form</field>
        <field name="view_id" ref="of_planning_intervention_view_form"/>
    </record>

    <record id="action_of_planning_tag_tree" model="ir.actions.act_window">
        <field name="name">Étiquettes d'intervention</field>
        <field name="res_model">of.planning.tag</field>
        <field name="view_type">form</field>
        <field name="view_mode">tree,form</field>
        <field name="view_id" ref="of_planning_tag_view_tree"/>
        <field name="search_view_id" ref="of_planning_tag_filter"/>
    </record>

    <record id="of_planning_intervention_action_generate_delivery" model="ir.actions.server">
        <field name="name">Générer le bon de livraison</field>
        <field name="model_id" ref="of_planning.model_of_planning_intervention"/>
        <field name="state">code</field>
        <field name="code">new_procs = records.mapped('line_ids').with_context(verif_state=False).sudo()._action_procurement_create()
# To return an action, assign: action = {...}
if new_procs._context.get('errors'):
    rdv_names = new_procs._context.get('errors')
    message = u"Nous n'avons pas pu générer les BL pour les RDVs suivants car il n'ont pas d'adresses renseignées :\n%s" % u"\n".join(rdv_names)
    action = env['of.popup.wizard'].popup_return(message=message)
</field>
    </record>

    <record id="of_planning_intervention_action_generate_delivery_values" model="ir.values">
        <field name="name">Générer le bon de livraison</field>
        <field name="key2">client_action_multi</field>
        <field name="model">of.planning.intervention</field>
        <field name="value" eval="'ir.actions.server,%d'%of_planning_intervention_action_generate_delivery"/>
    </record>


<!--#############################################______Copies d'actions_______#####################################################-->

    <!-- employés -->
    <record id="action_hr_employee_tree" model="ir.actions.act_window">
        <field name="name">Employés</field>
        <field name="res_model">hr.employee</field>
        <field name="view_type">form</field>
        <field name="view_mode">tree,form</field>
        <field name="view_id" ref="hr.view_employee_tree"/>
        <field name="context">{}</field>
    </record>

    <!-- équipes -->
    <record id="action_of_planning_equipe_tree" model="ir.actions.act_window">
        <field name="name">Equipes</field>
        <field name="res_model">of.planning.equipe</field>
        <field name="view_type">form</field>
        <field name="view_mode">tree,form</field>
        <field name="view_id" ref="view_of_planning_equipe_tree"/>
    </record>

    <!-- catégories de tâches -->
    <record id="action_of_planning_tache_categ_tree" model="ir.actions.act_window">
        <field name="name">Catégories de tâches</field>
        <field name="res_model">of.planning.tache.categ</field>
        <field name="view_type">form</field>
        <field name="view_mode">tree,form</field>
        <field name="view_id" ref="of_planning_tache_categ_view_tree"/>
    </record>

    <!-- tâches -->
    <record id="action_of_planning_tache_tree" model="ir.actions.act_window">
        <field name="name">Tâches</field>
        <field name="res_model">of.planning.tache</field>
        <field name="view_type">form</field>
        <field name="view_mode">tree,form</field>
        <field name="view_id" ref="of_planning_tache_view_tree"/>
    </record>

    <!-- créneaux horaires -->
    <record id="action_view_of_horaire_creneau_tree_intervention" model="ir.actions.act_window">
        <field name="name">Créneaux horaires</field>
        <field name="res_model">of.horaire.creneau</field>
        <field name="view_type">form</field>
        <field name="view_mode">form,tree</field>
        <field name="view_id" ref="of_calendar.view_of_horaire_creneau_tree"/>
        <field name="search_view_id" ref="of_calendar.view_of_horaire_creneau_filter"/>
    </record>

    <!-- secteurs -->
    <record id="action_of_secteur_tree_intervention" model="ir.actions.act_window">
        <field name="name">Secteurs</field>
        <field name="res_model">of.secteur</field>
        <field name="view_type">form</field>
        <field name="view_mode">tree,form</field>
        <field name="view_id" ref="of_base_location.of_view_secteur_tree"/>
        <field name="search_view_id" ref="of_base_location.of_view_secteur_filter"/>
    </record>

<!--################################################_Raison inacheve reporte_######################################################-->

    <record id="action_of_planning_intervention_raison_tree" model="ir.actions.act_window">
        <field name="name">Erreurs</field>
        <field name="res_model">of.planning.intervention.raison</field>
        <field name="view_type">form</field>
        <field name="view_mode">tree,form</field>
        <field name="view_id" ref="of_planning.of_planning_intervention_raison_tree"/>
    </record>

<!--##########################################################################################################################-->
<!--#######################################________Actions Dupliquées_________################################################-->
<!--##########################################################################################################################-->

    <record id="of_product_template_action_planning" model="ir.actions.act_window">
        <field name="name">Produits</field>
        <field name="type">ir.actions.act_window</field>
        <field name="res_model">product.template</field>
        <field name="view_mode">kanban,tree,form</field>
        <field name="view_type">form</field>
        <field name="view_id" ref="product.product_template_tree_view"/>
        <field name="context">{"search_default_filter_to_sell":1}</field>
        <field name="help" type="html">
            <p class="oe_view_nocontent_create">
                Click to define a new product.
            </p><p>
                You must define a product for everything you sell, whether it's a physical product, a consumable or a service you offer to customers.
            </p><p>
                The product form contains information to simplify the sale process: price, notes in the quotation, accounting data, procurement methods, etc.
            </p>
        </field>
    </record>

    <record id="of_template_open_kit_planning" model="ir.actions.act_window">
        <field name="name">Kits</field>
        <field name="res_model">product.template</field>
        <field name="domain">[('of_is_kit', '=', True)]</field>
        <field name="view_mode">tree, kanban, form</field>
        <field name="view_type">form</field>
        <field name="context">{"default_of_is_kit":1}</field>
    </record>
    <record id="of_template_open_kit_view_tree_planning" model="ir.actions.act_window.view">
        <field eval="0" name="sequence"/>
        <field name="view_mode">tree</field>
        <field name="view_id" ref="of_kit.of_product_template_kit_tree"/>
        <field name="act_window_id" ref="of_template_open_kit_planning"/>
    </record>
    <record id="of_template_open_kit_view_kanban_planning" model="ir.actions.act_window.view">
        <field eval="1" name="sequence"/>
        <field name="view_mode">kanban</field>
        <field name="view_id" ref="of_kit.of_kit_product_template_kanban_view"/>
        <field name="act_window_id" ref="of_template_open_kit_planning"/>
    </record>
    <record id="of_template_open_kit_view_form_planning" model="ir.actions.act_window.view">
        <field eval="2" name="sequence"/>
        <field name="view_mode">form</field>
        <field name="view_id" eval="False"/>
        <field name="act_window_id" ref="of_template_open_kit_planning"/>
    </record>

    <record id="action_of_partner_form_planning" model="ir.actions.act_window">
        <field name="name">Clients</field>
        <field name="type">ir.actions.act_window</field>
        <field name="res_model">res.partner</field>
        <field name="view_type">form</field>
        <field name="view_mode">kanban,tree,map,form</field>
        <field name="context">{"search_default_customer":1}</field>
        <field name="search_view_id" ref="base.view_res_partner_filter"/>
        <field name="help" type="html">
          <p class="oe_view_nocontent_create">
            Click to add a contact in your address book.
          </p><p>
            Odoo helps you easily track all activities related to
            a customer: discussions, history of business opportunities,
            documents, etc.
          </p>
        </field>
    </record>

<!--##########################################################################################################################-->
<!--#############################################_________Menus__________#####################################################-->
<!--##########################################################################################################################-->

    <menuitem id="menu_of_planning" name="Interventions" groups="group_planning_intervention_access" sequence="2" web_icon="of_planning,static/description/icon.png"/>

        <menuitem id="menu_of_planning_intervention" name="Interventions" parent="of_planning.menu_of_planning" groups="group_planning_intervention_access" sequence="10"/>
            <menuitem id="menu_of_planning_intervention_calendar" name="Planning" parent="of_planning.menu_of_planning_intervention" sequence="2" action="action_of_planning_intervention_calendar"/>

        <menuitem id="menu_of_planning_clients" name="Clients" parent="of_planning.menu_of_planning" sequence="20"/>
            <menuitem id="menu_of_planning_clients_clients" name="Clients" parent="of_planning.menu_of_planning_clients" action="action_of_partner_form_planning" sequence="10"/>

        <menuitem id="menu_of_planning_vente" name="Articles" parent="of_planning.menu_of_planning" sequence="30"
                  groups="sales_team.group_sale_salesman,account.group_account_invoice,stock.group_stock_user"/>
            <menuitem id="menu_of_planning_vente_articles" name="Articles" parent="of_planning.menu_of_planning_vente" action="of_product_template_action_planning" sequence="10"/>
            <menuitem id="menu_of_planning_vente_kits" name="Kits" parent="of_planning.menu_of_planning_vente" action="of_template_open_kit_planning" sequence="20"/>

        <menuitem id="menu_of_planning_configuration" name="Configuration" parent="of_planning.menu_of_planning" groups="group_planning_intervention_responsible" sequence="100"/>
            <menuitem id="menu_of_planning_configuration_res" name="Ressources" parent="of_planning.menu_of_planning_configuration" sequence="10"/>
                <menuitem name="Employés" id="menu_hr_employee_tree" parent="of_planning.menu_of_planning_configuration_res" sequence="10" action="action_hr_employee_tree"/>
                <menuitem name="Équipes" id="menu_of_planning_equipe_tree" parent="of_planning.menu_of_planning_configuration_res" sequence="20" action="action_of_planning_equipe_tree"/>
                <menuitem id="menu_hr_config_of_creneau_intervention" name="Créneaux horaires" parent="menu_of_planning_configuration_res" action="action_view_of_horaire_creneau_tree_intervention" sequence="30"/>
                <menuitem name="Catégories de tâches" id="menu_of_planning_tache_categ_tree" parent="of_planning.menu_of_planning_configuration_res" sequence="40" action="action_of_planning_tache_categ_tree"/>
                <menuitem name="Tâches" id="menu_of_planning_tache_tree" parent="of_planning.menu_of_planning_configuration_res" sequence="50" action="action_of_planning_tache_tree"/>
                <menuitem name="Erreurs" id="menu_of_planning_intervention_raison_tree" parent="of_planning.menu_of_planning_configuration_res" sequence="60" action="action_of_planning_intervention_raison_tree"/>
                <menuitem name="Secteurs" id="of_secteur_intervention_menu" parent="of_planning.menu_of_planning_configuration_res" action="action_of_secteur_tree_intervention" sequence="70"/>
                <menuitem name="Étiquettes d'intervention" id="menu_of_planning_tag_tree" parent="of_planning.menu_of_planning_configuration_res" sequence="80" action="action_of_planning_tag_tree"/>
            <menuitem id="menu_of_planning_configuration_template" name="Modèles" parent="of_planning.menu_of_planning_configuration" sequence="30"/>
                <menuitem name="Modèles de courriers" id="menu_of_planning_mail_templates" parent="of_planning.menu_of_planning_configuration_template" sequence="20" action="of_gesdoc.action_of_mail_template_tree_all" />

    <!-- Suppression des anciens groupes de certains menus (PEUT ÊTRE SUPPRIMÉ APRÈS APPLICATION) -->

    <record id="of_planning.menu_of_planning_configuration" model="ir.ui.menu">
        <field name="groups_id" eval="[(6, 0, [ref('of_planning.group_planning_intervention_responsible')])]"/>
    </record>

    <record id="of_planning.menu_hr_config_of_creneau_intervention" model="ir.ui.menu">
        <field name="groups_id" eval="[(6, 0, [])]"/>
    </record>

    <!-- Creation la facture depuis planning intervention -->

    <record id="action_of_create_invoice_intervention" model="ir.actions.server">
        <field name="name">Générer les factures</field>
        <field name="model_id" ref="model_of_planning_intervention"/>
        <field name="state">code</field>
        <field name="code">action = records.create_invoice()</field>
        <field name="groups">account.group_account_invoice</field>
    </record>

    <record id="action_create_invoice_intervention" model="ir.values">
        <field name="name">Générer les factures</field>
        <field name="key2">client_action_multi</field>
        <field name="model">of.planning.intervention</field>
        <field name="value" eval="'ir.actions.server,%d'%action_of_create_invoice_intervention"/>
        <field name="groups">account.group_account_invoice</field>
    </record>


<!--#################################_Ajout bouton interventions dans Devis_############################# -->

    <!-- Ajout bouton interventions dans devis -->
    <record id="of_sale_view_order_form" model="ir.ui.view">
        <field name="name">of.sale.order.form</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_order_form"/>
        <field name="arch" type="xml">
            <xpath expr="/form/sheet/div[@name='button_box']/button[@name='action_view_invoice']" position="after">
                <button class="oe_stat_button" name="action_view_intervention" type="object" icon="fa-calendar">
                        <field string="RDVs Tech" name="intervention_count" widget="statinfo"/>
                    </button>
                </xpath>
                <xpath expr="//field[@name='order_line']/form//field[@name='qty_delivered']/parent::node()" position="after">
                    <label for="of_qty_planning_done" string="Qté(s) réalisée(s)" invisible="context.get('hide_sale')"/>
                    <div invisible="context.get('hide_sale')">
                        <field name="of_qty_planning_done" invisible="context.get('hide_sale')"/>
                    </div>
                </xpath>
                <xpath expr="//field[@name='order_line']/tree" position="inside">
                    <field name="of_intervention_state"/>
                </xpath>
            </field>
    </record>

    <!-- Action pour afficher liste d'interventions -->
    <record id="of_sale_order_open_interventions" model="ir.actions.act_window">
        <field name="name">RDVs Tech</field>
        <field name="res_model">of.planning.intervention</field>
        <field name="domain">[]</field> <!-- Force empty -->
        <field name="view_type">form</field>
        <field name="view_mode">calendar,tree,form,pivot</field>
        <field name="view_id" ref="of_planning_intervention_view_calendar_with_jump"/>
        <field name="search_view_id" ref="of_planning_intervention_filter"/>
    </record>

    <record id="of_planning_sale_order_view_search_inherit_sale" model="ir.ui.view">
        <field name="name">of.planning.sale.order.search.inherit.sale</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.sale_order_view_search_inherit_sale"/>
        <field name="arch" type="xml">
            <xpath expr="//filter[3]" position="after">
                <filter string="Planification restante" domain="[('of_planned', '=', False)]" name="planned"/>
            </xpath>
        </field>
    </record>

    <record id="of_planning_sale_order_line_tree" model="ir.ui.view">
        <field name="name">of.planning.sale.order.line.tree</field>
        <field name="model">sale.order.line</field>
        <field name="inherit_id" ref="of_sale.of_sale_order_line_tree"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='of_invoice_policy']" position="after">
                <field name="of_intervention_state"/>
            </xpath>
        </field>
    </record>

    <!-- Stock Picking Form View -->
    <record id="of_planning_stock_picking_form_view" model="ir.ui.view">
        <field name="name">of.planning.stock.picking.form.view</field>
        <field name="model">stock.picking</field>
        <field name="inherit_id" ref="stock.view_picking_form"/>
        <field name="arch" type="xml">
            <xpath expr="//div[@name='button_box']" position="inside">
                <!-- Bouton RDV Techs -->
                <button class="oe_stat_button" name="action_view_interventions" type="object" icon="fa-calendar"
                        attrs="{'invisible': [('picking_type_code', '!=', 'outgoing')]}">
                    <field string="RDV(s) Tech" name="of_intervention_count" widget="statinfo"/>
                </button>
            </xpath>
        </field>
    </record>

</odoo>
