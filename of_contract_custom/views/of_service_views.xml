<?xml version="1.0" encoding="utf-8"?>
<odoo>

<!-- ******************************************************************************************* -->
<!-- ***************************************** SERVICE ***************************************** -->
<!-- ******************************************************************************************* -->

    <record id="of_contract_view_of_service_rec_filter" model="ir.ui.view">
        <field name="name">of.contract.view.of.service.rec.filter</field>
        <field name="model">of.service</field>
        <field name="inherit_id" ref="of_service.view_of_service_filter"/>
        <field name="arch" type="xml">
            <xpath expr="//search" position="inside">
                <field name="contract_line_id"/>
                <field name="contract_id"/>
            </xpath>
            <xpath expr="//filter[@name='filter_rec']" position="attributes">
                <attribute name="string">Récurrente</attribute>
            </xpath>
            <xpath expr="//filter[@name='filter_ponc']" position="attributes">
                <attribute name="string">Ponctuelle</attribute>
            </xpath>
            <xpath expr="//filter[@name='filter_rec']" position="after">
                <filter string="SAV" name="filter_sav"
                        domain="[('type_id', '=', %(of_contract_custom.of_contract_custom_type_sav)d)]"/>
                <filter string="Entretien" name="filter_entretien"
                        domain="[('type_id', '=', %(of_contract_custom.of_contract_custom_type_maintenance)d)]"/>
                <filter string="Installation" name="filter_installation"
                        domain="[('type_id', '=', %(of_contract_custom.of_contract_custom_type_installation)d)]"/>
                <filter string="Visite technique" name="filter_vt"
                        domain="[('type_id', '=', %(of_contract_custom.of_contract_custom_type_technical)d)]"/>
            </xpath>
        </field>
    </record>

    <record id="view_of_service_rec_tree_inh_contract" model="ir.ui.view">
        <field name="name">of.service.tree.contract.custom</field>
        <field name="inherit_id" ref="of_service.view_of_service_rec_tree"/>
        <field name="model">of.service</field>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='recurrence']" position="replace"/>
        </field>
    </record>

    <record id="view_of_contract_service_form" model="ir.ui.view">
        <field name="name">of.contract.service.form</field>
        <field name="model">of.service</field>
        <field name="arch" type="xml">
            <form>
                <header>
                    <button name="button_valider" string="Valider" states="draft" type="object"/>
                    <button name="button_annuler" string="Annuler" type="object"
                            attrs="{'invisible': [('base_state', '!=', 'calculated')]}"/>
                    <button name="button_brouillon" string="Remettre en brouillon" states="cancel" type="object"/>
                    <button name="transform_to_contract" string="Transformer" states="calculated" type="object"/>
                    <button name="of_planning_tournee.action_view_rdv_intervention_wizard_service" string="Planifier Intervention"
                            type="action" attrs="{'invisible': [('base_state', '!=', 'calculated')]}"/>
                    <button name="action_service_send" string="Envoyer par email" type="object"/>
                    <field name="kanban_step_id" widget="statusbar" clickable="True" options="{'fold_field': 'fold'}"/>
                </header>
                <sheet>
                    <field name="alert_dates" invisible="1"/>
                    <div class="oe_button_box" name="button_box">
                        <button name="action_view_saleorder"
                                type="object"
                                class="oe_stat_button"
                                icon="fa-usd">
                            <field name="saleorder_count" widget="statinfo" string="Ventes"/>
                        </button>
                        <button name="action_view_sale_invoice"
                                type="object"
                                class="oe_stat_button"
                                icon="fa-usd">
                            <field name="sale_invoice_count" widget="statinfo" string="Factures client"/>
                        </button>
                        <button class="oe_stat_button" name="action_view_intervention" type="object" icon="fa-calendar">
                            <field string="RDVs Tech" name="intervention_count" widget="statinfo"/>
                        </button>
                        <button name="toggle_active" type="object"
                                class="oe_stat_button" icon="fa-archive"
                                confirm="Êtes-vous sûr de vouloir archiver/activer ce service ?">
                            <field name="active" widget="boolean_button"
                                options='{"terminology": "archive"}'/>
                        </button>
                    </div>
                    <div class="of_title">
                        <h1><b>
                            <field name="priority" class="oe_inline of_ws" widget="priority" nolabel="1"/>
                            <span class="of_ws" attrs="{'invisible': [('number', '!=', False)]}">
                                Demande d'intervention
                            </span>
                            <field name="number" readonly="1" class="oe_inline of_ws"/>
                            <span attrs="{'invisible': [('titre', '=', False)]}" class="of_ws">-</span>
                            <field name="titre" class="oe_inline" placeholder="Titre de la demande..."/>
                        </b></h1>
                    </div>
                    <group col="4">
                        <field name="state" invisible="1"/>
                        <field name="base_state" invisible="1"/>
                        <group col="2" colspan="2">
                            <field name="type_id" />
                            <field name="template_id" context="{'type_prio_id': type_id}"
                                   attrs="{'readonly': [('number', '!=', False), ('base_state', 'not in', ('draft', 'cancel'))]}"/>
                            <field name="order_id" attrs="{'invisible': [('type_id','not in', [%(of_contract_custom.of_contract_custom_type_installation)d, %(of_contract_custom.of_contract_custom_type_maintenance)d, %(of_contract_custom.of_contract_custom_type_sav)d])]}"/>
                            <field name="contract_id" attrs="{'invisible': ['|', ('type_id','not in',[%(of_contract_custom.of_contract_custom_type_maintenance)d, %(of_contract_custom.of_contract_custom_type_sav)d]), ('recurrence','=', True)]}"/>
                            <field name="contract_line_id" context="{'display_address': True}" domain="[('contract_id', '=', contract_id)]"
                                   attrs="{'invisible': ['|', '|', ('contract_id', '=', False), ('type_id','not in',[%(of_contract_custom.of_contract_custom_type_maintenance)d, %(of_contract_custom.of_contract_custom_type_sav)d]), ('recurrence','=', True)]
                                           'required': [('contract_id', '!=', False)]}"/>
                            <field name="recurrence" attrs="{'invisible': ['|', '|', ('type_id','not in',[%(of_contract_custom.of_contract_custom_type_maintenance)d]), ('contract_id','!=', False), ('contract_line_id','!=', False)]}" groups="!of_contract_custom.group_of_contract_custom_lecture"/>
                            <field name="contract_message" nolabel="1" colspan="2"/>
                        </group>
                        <group col="2" colspan="2">
                            <field name="user_id"/>
                            <field name="tag_ids" widget="many2many_tags"/>
                        </group>
                        <group name="who" col="2" colspan="2" string="Qui" class="of_grey_background">
                            <group colspan="2">
                                <field name="employee_ids" widget="many2many_tags"/>
                                <field name="supplier_id"/>
                                <field name="company_id"/>
                            </group>
                        </group>
                        <group name="where" col="2" colspan="2" string="Où" class="of_grey_background">
                            <group colspan="2">
                                <field name="partner_id"/>
                                <field name="partner_code_magasin"/>
                                <field name="partner_tag_ids" widget="many2many_tags"/>
                                <label for="address_id" string="Adresse d'intervention"/>
                                <div class="o_address_format">
                                    <div><field name="address_id"/></div>
                                    <field name="address_street" class="o_address_street"/>
                                    <field name="address_street2" class="o_address_street"/>
                                    <field name="address_zip" class="o_address_zip of_ws"/>
                                    <field name="address_city" class="o_address_city"/>
                                    <div attrs="{'invisible': [('address_phone', '=', False)]}">
                                        <i class="fa fa-phone of_ws"/>
                                        <field name="address_phone"/>
                                    </div>
                                    <div attrs="{'invisible': [('address_mobile', '=', False)]}">
                                        <i class="fa fa-phone of_ws"/>
                                        <field name="address_mobile"/>
                                    </div>
                                </div>
                                <field name="partner_code_magasin"/>
                                <field name="secteur_tech_id"/>
                            </group>
                        </group>
                        <group name="what" col="2" colspan="2" string="Quoi" class="of_grey_background">
                            <group colspan="2">
                                <field name="tache_id"/>
                                <label for="duree" string="Durées"/>
                                <div>
                                    <field name="duree" widget="float_time" nolabel="1" class="oe_inline" attrs="{'invisible': [('state', '=', 'done')]}"/>
                                    <i class="oe_grey oe_inline" attrs="{'invisible': [('state', '=', 'done')]}"> estimée, dont </i>
                                    <field name="duree_planif" widget="float_time" nolabel="1" class="oe_inline" attrs="{'invisible': [('state', '=', 'done')]}"/>
                                    <i class="oe_grey oe_inline" attrs="{'invisible': [('state', '=', 'done')]}"> planifiée et </i>
                                    <field name="duree_restante" widget="float_time" nolabel="1" class="oe_inline" attrs="{'invisible': [('state', '=', 'done')]}"/>
                                    <i class="oe_grey oe_inline" attrs="{'invisible': [('state', '=', 'done')]}"> restante</i>
                                    <i class="oe_grey oe_inline" attrs="{'invisible': [('state', '!=', 'done')]}">
                                        Cette intervention est terminée
                                    </i>
                                </div>
                            </group>
                        </group>
                        <group name="when" col="2" colspan="2" string="Quand" class="of_grey_background">
                            <group colspan="2">
                                <field name="date_next" string="Entre le"/>
                                <field name="date_fin" string="et le"/>
                                <field name="jour_ids" widget="many2many_tags" options="{'no_create': True}"/>
                                <field name="mois_ids" widget="many2many_tags" options="{'no_create': True}" attrs="{'invisible': [('recurrence', '=', False)]}"/>
                                <label for="recurring_interval" attrs="{'invisible': [('recurrence', '=', False)]}"/>
                                <div attrs="{'invisible': [('recurrence', '=', False)]}" col="2">
                                    <field name="recurring_interval" nolabel="1" class="oe_inline of_ws"/>
                                    <field name="recurring_rule_type" nolabel="1" class="oe_inline"/>
                                </div>
                                <field name="recurrence_tache" invisible="1"/>
                            </group>
                        </group>
                    </group>
                    <notebook>
                        <page name="description" string="Description">
                            <group>
                                <field name="note" nolabel="1"/>
                            </group>
                        </page>
                        <page name="parc" string="Produit installé">
                            <group string="Produit installé" groups="project.group_project_user" colspan="2">
                                <field name="parc_installe_id" context="{'address_prio_id': address_id or partner_id}"/>
                                <field name="parc_installe_product_id"/>
                                <field name="parc_installe_site_adresse_id"/>
                                <field name="parc_installe_note"/>
                            </group>
                        </page>
                        <page name="historique" string="Historique">
                            <group name="interventions" string="Interventions">
                                <field colspan="4" mode="tree" name="historique_interv_ids" nolabel="1"
                                       widget="one2many_list">
                                    <tree string="Interventions">
                                        <field name="employee_ids" widget="many2many_tags"/>
                                        <field name="type_id"/>
                                        <field name="tache_id"/>
                                        <field name="date" string="Date"/>
                                        <field name="duree" string="Durée"/>
                                        <field name="date_deadline" string="Date fin"/>
                                        <field name="state"/>
                                        <field name="name"/>
                                        <field name="cleantext_description" string="Description"/>
                                    </tree>
                                </field>
                            </group>
                        </page>
                        <page name="facturation" string="Facturation">
                            <field name="currency_id" invisible="1"/>
                            <group>
                                <group>
                                    <field name="fiscal_position_id" options="{'no_create': True, 'no_open': True}"/>
                                </group>
                            </group>
                            <field name="line_ids">
                                <tree editable="bottom">
                                    <field name="product_id"/>
                                    <field name="name"/>
                                    <field name="qty"/>
                                    <field name="price_unit"/>
                                    <field name="taxe_ids" widget="many2many_tags"/>
                                    <field name="price_subtotal" readonly="1"/>
                                    <field name="price_total" readonly="1"/>
                                    <field name="sol_number"/>
                                </tree>
                            </field>
                            <group class="oe_subtotal_footer oe_right" colspan="2" name="intervention_total">
                                <field name="price_subtotal" widget="monetary"
                                       options="{'currency_field': 'currency_id'}"/>
                                <field name="price_tax" widget="monetary" options="{'currency_field': 'currency_id'}"/>
                                <div class="oe_subtotal_footer_separator oe_inline o_td_label">
                                    <label for="price_total"/>
                                </div>
                                <field name="price_total" nolabel="1" class="oe_subtotal_footer_separator"
                                       widget="monetary" options="{'currency_field': 'currency_id'}"/>
                            </group>
                        </page>
                        <page name="docs" string="Documents">

                        </page>
                    </notebook>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_follower_ids" widget="mail_followers"/>
                    <field name="message_ids" widget="mail_thread"/>
                </div>
            </form>
        </field>
    </record>

    <record id="of_contract_service_kanban_view" model="ir.ui.view">
        <field name="name">of.contract.service.kandan.view</field>
        <field name="model">of.service</field>
        <field name="arch" type="xml">
            <kanban class="o_kanban_small_column" default_group_by="kanban_step_id">
                <field name="type_id"/>
                <field name="kanban_step_id"/>
                <field name="date_next"/>
                <field name="date_fin"/>
                <field name="partner_id"/>
                <field name="address_id"/>
                <field name="address_address"/>
                <field name="spec_date"/>
                <templates>
                    <t t-name="kanban-box">
                        <div class="oe_kanban_card oe_kanban_global_click">
                            <div class="oe_kanban_content">
                                <div>
                                    <field name="tag_ids"/>
                                </div>
                                <strong class="oe_partner_heading"><field name="address_id"/> - <field name="type_id"/></strong>
                                <ul>
                                    <li t-if="record.address_address.raw_value"><field name="address_address"/></li>
                                    <br/>
                                    <li t-if="record.spec_date.raw_value"><field name="spec_date"/></li>
                                </ul>
                            </div>
                        </div>

                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <record id="action_of_contract_service_form_planning" model="ir.actions.act_window">
        <field name="name">Demandes d'intervention</field>
        <field name="type">ir.actions.act_window</field>
        <field name="res_model">of.service</field>
        <field name="view_type">form</field>
        <field name="view_mode">tree,kanban,map,form,pivot</field>
        <field name="search_view_id" ref="of_service.view_of_service_filter"/>
        <field name="context">{
            'form_view_ref': 'of_contract_custom.view_of_contract_service_form',
        }</field>
    </record>

    <record id="of_service.action_of_service_prog_form_planning" model="ir.actions.act_window">
        <field name="name">Demandes d'interventions</field>
        <field name="view_mode">tree,kanban,map,form,pivot</field>
    </record>

    <record id="of_service.action_service_prog_form_view_planning" model="ir.actions.act_window.view">
        <field name="sequence" eval="2"/>
        <field name="view_mode">form</field>
        <field name="view_id" ref="of_contract_custom.view_of_contract_service_form"/>
        <field name="act_window_id" ref="of_service.action_of_service_prog_form_planning"/>
    </record>

    <menuitem id="of_service.menu_of_planning_service_prog" name="Demandes d'intervention" parent="of_planning.menu_of_planning_intervention" sequence="5" action="of_contract_custom.action_of_contract_service_form_planning"/>
    <delete model="ir.ui.menu" id="of_service.menu_of_planning_service_rec"/>
    <delete model="ir.ui.menu" id="of_service.menu_of_planning_service_ponc"/>

    <!-- Générer devis depuis DI -->
    <record id="action_make_sale_order" model="ir.actions.server">
        <field name="name">Générer devis client</field>
        <field name="model_id" ref="of_service.model_of_service"/>
        <field name="state">code</field>
        <field name="code">action = obj.make_sale_order()</field>
    </record>
    <record id="value_make_sale_order" model="ir.values">
        <field name="name">Générer devis client</field>
        <field name="key2">client_action_multi</field>
        <field name="model">of.service</field>
        <field name="value" eval="'ir.actions.server,%d'%action_make_sale_order"/>
    </record>

</odoo>
