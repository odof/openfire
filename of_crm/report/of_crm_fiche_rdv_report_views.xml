<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <record id="paperformat_euro_portrait_custom" model="report.paperformat">
        <field name="name">European A4 Custom Portrait</field>
        <field name="default" eval="True" />
        <field name="format">A4</field>
        <field name="page_height">0</field>
        <field name="page_width">0</field>
        <field name="orientation">Portrait</field>
        <field name="margin_top">35</field>
        <field name="margin_bottom">23</field>
        <field name="margin_left">7</field>
        <field name="margin_right">7</field>
        <field name="header_line" eval="False" />
        <field name="header_spacing">25</field>
        <field name="dpi">90</field>
    </record>

    <!-- PDF version -->
    <report id="of_fiche_rdv_report"
        string="Fiche RDV"
        model="crm.lead"
        report_type="qweb-pdf"
        name="of_crm.of_fiche_rdv_report_template" 
        paperformat="paperformat_euro_portrait_custom">
    </report>

    <!-- preview version -->
    <report id="of_fiche_rdv_report_preview"
        string="Fiche RDV (preview)"
        model="crm.lead"
        report_type="qweb-html"
        name="of_crm.of_fiche_rdv_report_template" 
        paperformat="paperformat_euro_portrait_custom">
    </report>

    <template id="of_internal_layout">
       
       <!-- Multicompany -->
        <t t-if="o and 'company_id' in o">
            <t t-set="company" t-value="o.company_id"/>
        </t>
        <t t-if="not o or not 'company_id' in o">
            <t t-set="company" t-value="res_company"/>
        </t>
        <div class="header">
            <div class="row">
                <div class="col-xs-4 text-center">
                    <div style="max-width: 80%; vertical-align: middle; margin-top">
                        <img t-if="company.logo" t-att-src="'data:image/png;base64,%s' % company.logo" style="max-width: 100%; max-height: 200px;"/>
                    </div>
                </div>
                <div class="h3 col-xs-4 text-center" style="padding-top: 20px; vertical-align: middle;">
                    Fiche RDV<br/><strong style="padding-top: 8px"><span t-field="o.partner_id"/></strong>
                </div>
                <div class="h5 col-xs-4 text-right" style="vertical-align: top;">
                    <t t-if="o.of_ref">
                        <span t-field="o.of_ref"/>
                    </t>
                </div>
            </div>
        </div>    
        <t t-raw="0"/>
    </template>

    <template id="of_fiche_rdv_report_template">
        <t t-call="report.html_container">
            <t t-foreach="docs" t-as="o">
                <t t-call="of_crm.of_internal_layout">
                    <div class="page">
                        <!-- Report page content -->
                        <!-- Prospect -->
                        <div class="row h3">
                            <div class="col-xs-12"><strong>Prospect</strong></div>
                        </div>                    
                        <div class="row" style="border: 1px solid lightgray; border-top: 2px solid black;">
                            <div class="col-xs-6" style="border-right: 1px solid lightgray;">
                                <div class="h5">
                                    <t t-if="o.name">
                                        <div><span>Description : </span><strong><span t-field="o.name"/></strong></div>
                                    </t>
                                    <t t-if="o.of_ref">
                                        <div><span>Référence : </span><span t-field="o.of_ref"/></div>
                                    </t>
                                    <t t-if="o.partner_id">
                                        <div><span>Client : </span><strong><span t-field="o.partner_id"/></strong></div>
                                    </t>
                                    <!-- t t-if="o.partner_name">
                                        <div><span>Client : </span><span t-field="o.partner_name"/></div>
                                    </t-->
                                    <t t-if="o.street">
                                        <span>Adresse :</span>
                                        <span t-field="o.street"/>
                                    </t> 
                                    <t t-if="o.street2">
                                        <span t-field="o.street2"/>
                                    </t>
                                    <div>    
                                        <t t-if="o.zip">
                                            <span style="color: white">Adresse :</span>
                                            <span t-field="o.zip"/>
                                        </t>    
                                        <t t-if="o.city">
                                            <span t-field="o.city"/>
                                        </t>
                                        <t t-if="o.country_id">
                                            <span t-field="o.country_id"/>
                                        </t>
                                    </div>
                                    <t t-if="o.phone">
                                        <div><span>Téléphone : </span><span t-field="o.phone"/></div>
                                    </t>
                                    <t t-if="o.mobile">
                                        <div><span>Mobile : </span><span t-field="o.mobile"/></div>
                                    </t>
                                    <t t-if="o.email_from">
                                        <div><span>Courriel : </span><span t-field="o.email_from"/></div>
                                    </t>
                                </div>
                            </div>        
                            <div class="col-xs-6"> 
                                <div class="h5">
                                     <t t-if="o.of_date_prospection">
                                        <div><span>Date de creation : </span><span t-field="o.of_date_prospection"/></div>
                                     </t>
                                     <t t-if="o.user_id">
                                        <div><span>Commercial : </span><span t-field="o.user_id"/></div>
                                     </t>
                                     <t t-if="o.of_prospecteur">
                                        <div><span>Prospecteur : </span><span t-field="o.of_prospecteur"/></div>
                                     </t>
                                     <t t-if="o.referred">
                                        <div><span>Apporté par : </span><span t-field="o.referred"/></div>
                                     </t>
                                     <t t-if="o.campaign_id">
                                        <div><span>Campagne : </span><span t-field="o.campaign_id"/></div>
                                     </t>
                                     <t t-if="o.medium_id">
                                        <div><span>Canal : </span><span t-field="o.medium_id"/></div>
                                     </t>
                                     <t t-if="o.opt_out">
                                        <div><span>Option de retrait : Oui </span></div>
                                     </t>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Projet -->
                        <div class="row h3 mt32">
                            <div class="col-xs-12"><strong>Projet</strong></div>
                        </div>
                        
                        <div class="row" style="border: 1px solid lightgray; border-top: 2px solid black;">
                             <div class="col-xs-12" style="display: table;">
                                 <div t-if="o.of_modele_id or o.date_deadline" style="border-right: 1px solid lightgray; width: 50%; display: table-cell;">
                                     <div t-if="o.of_modele_id" class="h5">
                                         <span>Modèle : </span><span t-field="o.of_modele_id"/>
                                     </div>
                                 </div>
                                 <div t-if="o.of_modele_id or o.date_deadline" style="width: 50%; display: table-cell; padding: 0px 16px;"> 
                                     <div t-if="o.date_deadline" class="h5">
                                         <div><span>Date du projet : </span><span t-field="o.date_deadline"/></div>
                                     </div>
                                 </div>
                             </div>
                             <div class="col-xs-12" style="display: table; border-top: 1px solid lightgray">
                                 <div style="border-right: 1px solid lightgray; width: 50%; display: table-cell;"> 
                                     <div class="h5">
                                         <!-- Get fields -->
                                         <t t-foreach="o.of_projet_line_ids" t-as="entree">
                                             <t t-set="name_val" t-value="entree.get_name_and_val()"/>
                                             <span t-if="name_val[0] == 'Nom projet'">
                                                 <span t-esc="name_val[0]"/><span> : </span><strong><span t-esc="name_val[1]"/></strong><br/>
                                             </span>
                                             <span t-else="">
                                                 <span t-esc="name_val[0]"/><span> : </span><span t-esc="name_val[1]"/>
                                             </span>
                                         </t>
                                     </div>
                                 </div>
                                 <div style="width: 50%; display: table-cell; padding: 0px 16px;">
                                     <div class="h5">
                                         <t t-if="o.planned_revenue">
                                             <div><span>Revenu espéré : </span><span t-field="o.planned_revenue"/> €</div>
                                         </t>
                                         <t t-if="o.probability">
                                             <div><span>Probabilité : </span><span t-field="o.probability"/><span> %</span></div>
                                         </t>
                                         <t t-if="o.stage_id">
                                             <div><span>Étape : </span><span t-field="o.stage_id"/></div>
                                         </t>                                   
                                     </div>
                                 </div>
                             </div>
                        </div>
    
                        <!-- Reunions -->
                        <div class="row h3 mt32">
                            <div class="col-xs-12"><strong>Rendez-vous</strong></div>
                        </div>
                        <div t-if="o.meeting_ids" class="row" style="border: 1px solid lightgray; border-top: 2px solid black;">
                            <div class="col-xs-12"> 
                                <div class="h5">
                                    <table width="100%" class="table table-striped">
                                        <thead>
                                            <th>Sujet</th>
                                            <th>Date</th>
                                            <th>Description</th>
                                            <th>Participants</th>
                                        </thead>
                                        <t t-set="date_sorted_meetings" t-value="o.meeting_ids.sorted(key=lambda k: k.start)"/>
                                        <tr t-foreach="date_sorted_meetings" t-as="meeting">
                                            <t t-set="meeting_data" t-value="meeting.get_meeting_data()"/>
                                            <t t-foreach="meeting_data" t-as="key">
                                                <t t-if="key=='start'" t-set="value" t-value="meeting[key][8:10] + '/' + meeting[key][5:7] + '/' + meeting[key][0:4] + '  ' + meeting[key][11:16]"/>
                                                <t t-elif="key=='partner_ids'">
                                                    <td>
                                                        <t t-set="bool_tiret" t-value="False"/>
                                                        <t t-foreach="meeting.partner_ids" t-as="partner">
                                                            <span t-if="bool_tiret == True">- </span>
                                                            <t t-set="value" t-value="partner.get_crm_partner_name()"/>
                                                            <span t-esc="value"/>
                                                            <t t-if="bool_tiret == False" t-set="bool_tiret" t-value="True"/>
                                                        </t>
                                                    </td>
                                                </t>
                                                <t t-else="" t-set="value" t-value="meeting[key]"/>
                                                <td t-if="meeting[key] and key != 'partner_ids'" t-esc="value"/>
                                                <td t-elif="not meeting[key]"/>
                                            </t>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div t-else="" class="row" style="border: 1px solid lightgray; border-top: 2px solid black;">
                            <div class="col-xs-12 h5">
                                Aucun rendez-vous planifié.
                            </div> 
                        </div>
    
                        <!-- Qualification et Suivi -->
                        <div class="row h3 mt32">
                            <div class="col-xs-12"><strong>Qualification et Suivi</strong></div>
                        </div>
                        <div class="row" style="border: 1px solid lightgray; border-top: 2px solid black;">
                            <div class="col-xs-6"> 
                                <div class="h5">
                                    <t t-if="o.next_activity_id">
                                        <div><span>Activité suivante : </span><span t-field="o.next_activity_id"/>
                                             <t t-if="o.date_action">
                                                 <span>  ( Date : </span>
                                                 <span t-field="o.date_action"/>
                                                 <span> )</span>
                                             </t>   
                                        </div>
                                        <t t-if="o.title_action">
                                            <div><span>Description de l'action : </span><span t-field="o.title_action"/></div>
                                        </t>
                                    </t>
                                    <t t-if="o.of_date_prospection">
                                        <div>
                                            <span>Date de création : </span>
                                            <span t-field="o.of_date_prospection"/>
                                        </div>
                                    </t>
                                    <t t-if="o.date_deadline">
                                        <div>
                                            <span>Date du projet : </span>
                                            <span t-field="o.date_deadline"/>
                                        </div>
                                    </t>
                                    <t t-if="o.of_date_cloture">
                                        <div>
                                            <span>Date de clôture : </span>
                                            <span t-field="o.of_date_cloture"/>
                                        </div>
                                    </t>
                                    <t t-if="o.company_id">
                                        <div>
                                            <span>Société : </span>
                                            <span t-field="o.company_id"/>
                                        </div>
                                    </t>
                                    <t t-if="o.tag_ids">
                                        <div>
                                            <span>Étiquettes : </span>
                                            <t t-set="bool_tiret" t-value="False"/>
                                            <t t-foreach="o.tag_ids" t-as="tag_id">
                                                <span t-if="bool_tiret == True">- </span>
                                                <t t-set="tags_data" t-value="tag_id.get_crm_tags_data()"/>
                                                    <span t-esc="tags_data"/>
                                                <t t-if="bool_tiret == False" t-set="bool_tiret" t-value="True"/>
                                            </t>
                                        </div>
                                    </t>
                                </div>
                            </div>
                        </div>
                    </div>         
                </t>
            </t>
        </t>
    </template> 

    <template id="of_fiche_rdv_report_translated">
        <t t-call="of_fiche_rdv_report_template" t-lang="user.lang" >
            <t t-set="docs" t-value="docs" />
        </t>
    </template>

</odoo>
