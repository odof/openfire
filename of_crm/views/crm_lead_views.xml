<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- OF CRM Activity views -->

    <record id="of_crm_activity_form_view" model="ir.ui.view">
        <field name="name">of.crm.activity.form.view</field>
        <field name="model">of.crm.activity</field>
        <field name="arch" type="xml">
            <form>
                <field name="load_attachment" invisible="1"/>
                <field name="uploaded_attachment_id" invisible="1"/>
                <header>
                    <button name="action_add_attachment" icon="fa-upload" type="object" string="Add attachments"
                        attrs="{'invisible': ['|', ('load_attachment', '=', False), ('uploaded_attachment_id', '!=', False)]}"/>
                    <button string="Plan" name="action_plan" type="object" states="cancelled,done"/>
                    <button name="action_complete" string="Réaliser" type="object" class="oe_highlight"
                            attrs="{'invisible': [('state', '!=', 'planned')]}"/>
                    <button name="action_cancel" string="Annuler" type="object" class="btn-link"
                            attrs="{'invisible': [('state', '!=', 'planned')]}"/>
                    <field name="state" widget="statusbar"/>
                </header>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button name="toggle_active" type="object" class="oe_stat_button" icon="fa-archive">
                            <field name="active" widget="boolean_button"
                                   options="{&quot;terminology&quot;: &quot;archive&quot;}"/>
                        </button>
                    </div>
                    <group>
                        <group>
                            <field name="origin" invisible="1"/>
                            <field name="order_id" attrs="{'invisible':[('origin', '!=', 'sale_order')], 'required':[('origin', '=', 'sale_order')]}" />
                            <field name="opportunity_id" attrs="{'invisible':[('origin', '!=', 'opportunity')], 'required':[('origin', '=', 'opportunity')]}"/>
                            <field name="partner_id"/>
                            <field name="type_id"/>
                            <field name="trigger_type" attrs="{'invisible':[('origin', '!=', 'sale_order')], 'required':[('origin', '=', 'sale_order')]}"/>
                            <field name="title"/>
                            <field name="phone" widget="phone" attrs="{'invisible':[('origin', '!=', 'opportunity')]}"/>
                            <field name="mobile" widget="phone" attrs="{'invisible':[('origin', '!=', 'opportunity')]}"/>
                            <field name="email" string="Courriel" widget="email" attrs="{'invisible':[('origin', '!=', 'opportunity')]}"/>
                        </group>
                        <group>
                            <field name="is_late" invisible="1"/>
                            <field name="date" attrs="{'required':[('origin', '=', 'opportunity')]}"/>
                            <field name="deadline_date"/>
                            <field name="done_date" attrs="{'invisible':[('state', '!=', 'done')]}"/>
                            <field name="user_id"/>
                            <label for="vendor_id" string="Commercial" attrs="{'invisible':[('origin', '!=', 'opportunity')]}"/>
                            <label for="vendor_id" string="Assigné à" attrs="{'invisible':[('origin', '!=', 'sale_order')]}"/>
                            <field name="vendor_id" nolabel="1" attrs="{'required':[('origin', '=', 'opportunity')]}"/>
                        </group>
                        <group string="Description" colspan="4">
                            <field name="description" nolabel="1"/>
                        </group>
                        <group string="Compte-rendu" colspan="4">
                            <field name="report" nolabel="1"/>
                        </group>
                        <group string="Raison d'annulation" colspan="4">
                            <field name="cancel_reason" nolabel="1"/>
                        </group>
                    </group>
                </sheet>
            </form>
        </field>
    </record>

    <!-- This form view is used for the O2M in the Lead -->
    <record id="of_crm_activity_from_opportunity_form_view" model="ir.ui.view">
        <field name="name">of.crm.activity.form.view</field>
        <field name="model">of.crm.activity</field>
        <field name="priority" eval="20"/>
        <field name="arch" type="xml">
            <form>
                <field name="active" invisible="1"/>
                <field name="load_attachment" invisible="1"/>
                <field name="uploaded_attachment_id" invisible="1"/>
                <header>
                    <button name="action_add_attachment" icon="fa-upload" type="object" string="Add attachments"
                        attrs="{'invisible': ['|', ('load_attachment', '=', False), ('uploaded_attachment_id', '!=', False)]}"/>
                    <button string="Plan" name="action_plan" type="object" states="cancelled,done"/>
                    <button name="action_complete" string="Réaliser" type="object" class="oe_highlight"
                            attrs="{'invisible': [('state', '!=', 'planned')]}"/>
                    <button name="action_cancel" string="Annuler" type="object" class="btn-link"
                            attrs="{'invisible': [('state', '!=', 'planned')]}"/>
                    <field name="state" widget="statusbar"/>
                </header>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button name="toggle_active" type="object" class="oe_stat_button" icon="fa-archive">
                            <field name="active" widget="boolean_button"
                                   options="{&quot;terminology&quot;: &quot;archive&quot;}"/>
                        </button>
                    </div>
                    <group>
                        <field name="opportunity_id" invisible="1"/>
                        <field name="is_late" invisible="1"/>
                        <group>
                            <field name="type_id" domain="['|', ('of_object', '=', 'opportunity'), ('of_object', '=', False)]"/>
                            <field name="title"/>
                        </group>
                        <group>
                            <field name="origin" invisible="1"/>
                            <field name="date" required="1"/>
                            <field name="deadline_date"/>
                            <field name="user_id"/>
                            <field name="vendor_id" required="1"/>
                        </group>
                        <group string="Description" colspan="4">
                            <field name="description" nolabel="1"/>
                        </group>
                        <group string="Compte-rendu" colspan="4">
                            <field name="report" nolabel="1"/>
                        </group>
                        <group string="Raison d'annulation" colspan="4">
                            <field name="cancel_reason" nolabel="1"/>
                        </group>
                    </group>
                </sheet>
            </form>
        </field>
    </record>

    <!-- This form view is used for the O2M in the Sale -->
    <record id="of_crm_activity_from_sale_form_view" model="ir.ui.view">
        <field name="name">of.crm.activity.sale.form.view</field>
        <field name="model">of.crm.activity</field>
        <field name="priority" eval="20"/>
        <field name="arch" type="xml">
            <form>
                <field name="load_attachment" invisible="1"/>
                <field name="uploaded_attachment_id" invisible="1"/>
                <header>
                    <button name="action_add_attachment" icon="fa-upload" type="object" string="Add attachments"  attrs="{'invisible': ['|', ('load_attachment', '=', False), ('uploaded_attachment_id', '!=', False)]}"/>
                    <button name="action_plan" string="Plan" type="object" states="cancelled,done"/>
                    <button name="action_complete" string="Complete" type="object" class="oe_highlight" attrs="{'invisible': [('state', '!=', 'planned')]}"/>
                    <button name="action_cancel" string="Annuler" type="object" class="btn-link" attrs="{'invisible': [('state', '!=', 'planned')]}"/>
                    <field name="state" widget="statusbar"/>
                </header>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button name="toggle_active" type="object" class="oe_stat_button" icon="fa-archive">
                            <field name="active" widget="boolean_button"
                                   options="{&quot;terminology&quot;: &quot;archive&quot;}"/>
                        </button>
                    </div>
                    <group>
                        <field name="order_id" invisible="1"/>
                        <field name="is_late" invisible="1"/>
                        <group>
                            <field name="type_id" domain="['|', ('of_object', '=', 'sale_order'), ('of_object', '=', False)]"/>
                            <field name="trigger_type" required="1"/>
                            <field name="title"/>
                        </group>
                        <group>
                            <field name="origin" invisible="1"/>
                            <field name="deadline_date"/>
                            <field name="user_id"/>
                            <field name="vendor_id" string="Assigned to"/>
                        </group>
                        <group string="Description" colspan="4">
                            <field name="description" nolabel="1"/>
                        </group>
                        <group string="Compte-rendu" colspan="4">
                            <field name="report" nolabel="1"/>
                        </group>
                        <group string="Raison d'annulation" colspan="4">
                            <field name="cancel_reason" nolabel="1"/>
                        </group>
                    </group>
                </sheet>
            </form>
        </field>
    </record>

    <record id="of_crm_activity_tree_view" model="ir.ui.view">
        <field name="name">of.crm.activity.tree.view</field>
        <field name="model">of.crm.activity</field>
        <field name="arch" type="xml">
            <tree decoration-muted="state=='canceled'" decoration-danger="is_late">
                <field name="is_late" invisible="1"/>
                <field name="load_attachment" invisible="1"/>
                <field name="uploaded_attachment_id" invisible="1"/>
                <field name="opportunity_id"/>
                <field name="partner_id"/>
                <field name="title"/>
                <field name="type_id"/>
                <field name="date"/>
                <field name="user_id"/>
                <field name="vendor_id"/>
                <field name="state"/>
                <button name="action_add_attachment" icon="fa-upload" type="object" string="Add attachments"
                    attrs="{'invisible': ['|', ('load_attachment', '=', False), ('uploaded_attachment_id', '!=', False)]}"/>
                <button name="action_plan" icon="fa-undo" type="object" string="Plan"
                    attrs="{'invisible': [('state', '=', 'planned')]}"/>
                <button name="action_complete" type="object" string="Réaliser" icon="fa-check"
                        attrs="{'invisible': [('state', '!=', 'planned')]}"/>
                <button name="action_cancel" type="object" string="Annuler" icon="fa-close"
                        attrs="{'invisible': [('state', '!=', 'planned')]}"/>
            </tree>
        </field>
    </record>

    <!-- Tree view for the CRM activities of Sales Order -->
    <record id="of_crm_activity_sale_tree_view" model="ir.ui.view">
        <field name="name">of.crm.activity.sale.tree.view</field>
        <field name="model">of.crm.activity</field>
        <field name="arch" type="xml">
            <tree decoration-muted="state=='canceled'" decoration-danger="is_late">
                <field name="is_late" invisible="1"/>
                <field name="load_attachment" invisible="1"/>
                <field name="uploaded_attachment_id" invisible="1"/>
                <field name="order_id"/>
                <field name="partner_id"/>
                <field name="title"/>
                <field name="type_id"/>
                <field name="date"/>
                <field name="deadline_date"/>
                <field name="done_date"/>
                <field name="user_id"/>
                <field name="vendor_id" string="Assigned to"/>
                <field name="report"/>
                <field name="state"/>
                <button name="action_add_attachment" icon="fa-upload" type="object" string="Add attachments"
                    attrs="{'invisible': ['|', ('load_attachment', '=', False), ('uploaded_attachment_id', '!=', False)]}"/>
                <button name="action_plan" icon="fa-undo" type="object" string="Plan"
                    attrs="{'invisible': [('state', '=', 'planned')]}"/>
                <button name="action_complete" type="object" string="Complete" icon="fa-check"
                        attrs="{'invisible': [('state', '!=', 'planned')]}"/>
                <button name="action_cancel" type="object" string="Cancel" icon="fa-close"
                        attrs="{'invisible': [('state', '!=', 'planned')]}"/>
            </tree>
        </field>
    </record>

    <record id="of_crm_activity_search_view" model="ir.ui.view">
        <field name="name">of.crm.activity.search.view</field>
        <field name="model">of.crm.activity</field>
        <field name="arch" type="xml">
            <search>
                <field name="partner_id"/>
                <field name="opportunity_id"/>
                <field name="order_id"/>
                <field name="title"/>
                <field name="type_id"/>
                <field name="date"/>
                <field name="user_id"/>
                <field name="vendor_id"/>
                <separator/>
                <filter string="Planned" name="planned" domain="[('state', '=', 'planned')]"/>
                <filter string="Done" name="done" domain="[('state', '=', 'done')]"/>
                <filter string="Canceled" name="canceled" domain="[('active', '=', False), ('state', '=', 'canceled')]"/>
                <separator/>
                <filter string="Archived" name="archived" domain="[('active', '=', False)]"/>
                <separator/>
                <filter string="My activities" name="my_activities" domain="[('vendor_id', '=', uid)]"/>
                <separator/>
                <filter string="CRM" name="crm_activities" domain="[('origin', '=', 'opportunity')]"/>
                <filter string="Sales" name="sale_activities" domain="[('origin', '=', 'sale_order')]"/>
                <separator/>
                <filter string="Activities of the day" name="today"
                        domain="[('date', '&gt;=', current_date),
                                 ('date', '&lt;', (context_today() + datetime.timedelta(days=1)).strftime('%Y-%m-%d'))]"/>
                <filter string="Activities of the week" name="this_week"
                        domain="[('date', '&gt;=', (context_today() - datetime.timedelta(days=context_today().weekday())).strftime('%Y-%m-%d')),
                                 ('date', '&lt;', (context_today() + datetime.timedelta(days=7-context_today().weekday())).strftime('%Y-%m-%d'))]"/>
                <filter string="Overdue activities" name="overdue" domain="[('is_late', '=', True)]"/>
                <group expand="0" string="Group By" colspan="16">
                    <filter string="Opportunity" context="{'group_by':'opportunity_id'}"/>
                    <filter string="Order" domain="[]" context="{'group_by':'order_id'}"/>
                    <filter string="Customer" domain="[]" context="{'group_by':'partner_id'}"/>
                    <filter string="Activity type" context="{'group_by':'type_id'}"/>
                    <filter string="Author" context="{'group_by':'user_id'}"/>
                    <filter string="Assigned to" domain="[]" context="{'group_by':'vendor_id'}"/>
                </group>
            </search>
        </field>
    </record>

    <record id="of_crm_activity_calendar_view" model="ir.ui.view">
        <field name="name">of.crm.activity.calendar.view</field>
        <field name="model">of.crm.activity</field>
        <field name="arch" type="xml">
            <calendar date_start="date" color="vendor_id" attendee="vendor_id" attendee_model="res.users"
                      color_ft_field="of_color_ft" color_bg_field="of_color_bg" custom_colors="1" quick_add="0">
                <field name="opportunity_id"/>
                <field name="type_id"/>
                <field name="title"/>
                <field name="of_color_ft" invisible="1"/>
                <field name="of_color_bg" invisible="1"/>
            </calendar>
        </field>
    </record>

    <record id="of_crm_activity_action" model="ir.actions.act_window">
        <field name="name">Activités</field>
        <field name="res_model">of.crm.activity</field>
        <field name="view_type">form</field>
        <field name="view_mode">tree,form,calendar</field>
        <field name="view_id" ref="of_crm_activity_tree_view"/>
        <field name="search_view_id" ref="of_crm_activity_search_view"/>
        <field name="context">{'default_origin': 'opportunity', 'search_default_crm_activities': 1, 'active_test': False}</field>
    </record>

    <record id="of_crm_activity_sale_action" model="ir.actions.act_window">
        <field name="name">Activités</field>
        <field name="res_model">of.crm.activity</field>
        <field name="view_type">form</field>
        <field name="view_mode">tree,form,calendar</field>
        <field name="view_id" ref="of_crm_activity_sale_tree_view"/>
        <field name="search_view_id" ref="of_crm_activity_search_view"/>
        <field name="context">{'default_origin': 'sale_order', 'search_default_sale_activities': 1, 'active_test': False}</field>
    </record>

    <record id="of_crm_activity_schedule_action" model="ir.actions.act_window">
        <field name="name">Activité</field>
        <field name="res_model">of.crm.activity</field>
        <field name="view_mode">form</field>
        <field name="view_id" ref="of_crm_activity_from_opportunity_form_view"/>
        <field name="context">{'default_origin': 'opportunity'}</field>
    </record>

    <record id="of_crm_next_activities_action" model="ir.actions.act_window">
        <field name="name">Prochaines activités</field>
        <field name="res_model">of.crm.activity</field>
        <field name="view_mode">tree,form,calendar</field>
        <field name="view_id" ref="of_crm_activity_tree_view"/>
        <field name="search_view_id" ref="of_crm_activity_search_view"/>
        <field name="context">{
                'form_view_ref':'of_crm.of_crm_activity_form_view',
                'default_origin': 'opportunity',
                'default_vendor_id': uid,
                'search_default_my_activities': 1,
                'search_default_planned': 1,
            }
        </field>
    </record>

<!-- #######################################################################################
                          PISTES & OPPORTUNITES (crm.lead, crm.stage)
############################################################################################ -->
        <!--
            crm.lead (as Lead) views
        -->

        <!-- Ajout dans le contexte "hide_sale: True" qui a été oublié par Odoo pour ne pas afficher les champs "Livré" et "Facturé" dans ligne de commande d'un devis affiché depuis le smart bottom "Devis" du pipeline
             ainsi que les filtres par défaut "devis ou devis envoyés" -->
        <record id="sale_crm.sale_action_quotations_new"  model="ir.actions.act_window">
            <field name="context">{'search_default_opportunity_id': active_id, 'default_opportunity_id': active_id, 'hide_sale': True, 'search_default_draft': 1, 'search_default_sent': 1}</field>
        </record>
        <record id="sale_crm.sale_action_quotations"  model="ir.actions.act_window">
            <field name="context">{'search_default_opportunity_id': active_id, 'default_opportunity_id': active_id, 'hide_sale': True, 'search_default_draft': 0, 'search_default_sent': 0}</field>
        </record>

        <!-- CRM Lead Form View  -->
        <record model="ir.ui.view" id="of_crm_case_form_view_leads">
            <field name="name">of.crm.lead.form - Leads</field>
            <field name="model">crm.lead</field>
            <field name="inherit_id" ref="crm.crm_case_form_view_leads"/>
            <field name="arch" type="xml">
                <div class="o_address_format" position="after">
                    <field name="of_website" widget="url"/>
                </div>
            </field>
        </record>

        <!-- CRM Lead Tree View -->
        <record model="ir.ui.view" id="of_crm_case_tree_view_leads">
            <field name="name">of.crm.lead.tree - Leads</field>
            <field name="model">crm.lead</field>
            <field name="inherit_id" ref="crm.crm_case_tree_view_leads"/>
            <field name="arch" type="xml">
                <field name="create_date" position="attributes">
                    <attribute name="invisible">True</attribute>
                </field>
                <field name="contact_name" position="after">
                    <field name="zip"/>
                    <field name="city"/>
                </field>
                <field name="country_id" position="attributes">
                    <attribute name="invisible">True</attribute>
                </field>
                <field name="email_from" position="attributes">
                    <attribute name="invisible">True</attribute>
                </field>
                <field name="phone" position="attributes">
                    <attribute name="invisible">True</attribute>
                </field>
                <field name="team_id" position="attributes">
                    <attribute name="invisible">True</attribute>
                </field>
                <field name="team_id" position="after">
                    <field name="priority"/>
                    <field name="tag_ids"/>
                </field>
            </field>
        </record>

        <!-- CRM Lead Search View -->
        <record id="of_view_crm_case_leads_filter" model="ir.ui.view">
            <field name="name">of.crm.lead.search - Leads</field>
            <field name="model">crm.lead</field>
            <field name="inherit_id" ref="crm.view_crm_case_leads_filter"/>
            <field name="arch" type="xml">
                <field name="name" position="after">
                    <field name="zip"/>
                    <field name="contact_name"/>
                    <field name="of_projet_line_ids" string="Projet"/>
                </field>
            </field>
        </record>

        <record id="of_crm_case_kanban_view_leads" model="ir.ui.view">
            <field name="name">of.crm.lead.kanban.lead</field>
            <field name="model">crm.lead</field>
            <field name="inherit_id" ref="crm.crm_case_kanban_view_leads"/>
            <field name="arch" type="xml">
                <xpath expr="//kanban//field[@name='company_currency']" position="after">
                    <field name="of_customer_state"/>
                </xpath>
                <!-- ajout pastille prospect -->
                <xpath expr="//kanban//templates//div[@class='o_kanban_footer']//field[@name='priority']" position="after">
                    <div class="label label-success" attrs="{'invisible': [('of_customer_state', '!=', 'lead')]}">Prospect</div>
                    <div class="label label-info" attrs="{'invisible': [('of_customer_state', '!=', 'customer')]}">Client</div>
                </xpath>
                <field name="date_action" position="replace">
                    <field name="of_date_action"/>
                </field>
                <field name="title_action" position="replace">
                    <field name="of_title_action"/>
                </field>
                <xpath expr="//kanban//templates//div[@class='o_kanban_footer']/div/a[1]" position="replace">
                    <a name="action_view_activity" type="object" t-if="record.kanban_state.raw_value!='grey'">
                        <span t-att-title="record.of_date_action.value + ' : '+ record.of_title_action.value"
                              t-attf-class="oe_kanban_status oe_kanban_status_#{record.kanban_state.raw_value}"/>
                    </a>
                </xpath>
                <xpath expr="//kanban//templates//div[@class='o_kanban_footer']/div/a[2]" position="replace">
                    <a name="action_view_activity" type="object" t-if="record.kanban_state.raw_value=='grey'">
                        <span class="oe_kanban_status oe_kanban_status_grey"/>
                    </a>
                </xpath>
                <xpath expr="//kanban//field[@name='company_currency']" position="after">
                    <field name="user_id"/>
                </xpath>
                <xpath expr="//kanban/templates//field[@name='name']/parent::node()" position="after">
                    <span t-if="record.user_id"> - </span><field name="user_id"/>
                </xpath>
            </field>
        </record>

        <!-- couleurs personnalisées -->
        <record  id="of_crm_case_calendar_view_leads" model="ir.ui.view">
            <field name="name">of.crm.lead.calendar.lead</field>
            <field name="model">crm.lead</field>
            <field name="inherit_id" ref="crm.crm_case_calendar_view_leads"/>
            <field name="arch" type="xml">
                <xpath expr="//calendar" position="replace">
                    <calendar string="Leads Generation" date_start="of_date_action" color="user_id" attendee="user_id"
                      attendee_model="res.users" color_ft_field="of_color_ft" color_bg_field="of_color_bg" custom_colors="1">
                        <field name="name"/>
                        <field name="of_title_action"/>
                        <field name="of_color_ft" invisible="1"/>
                        <field name="of_color_bg" invisible="1"/>
                        <field name="partner_name" invisible="1"/>
                    </calendar>
                </xpath>
            </field>
        </record>

        <!--####################### QUICK CREATE ##########################-->
        <record id="of_crm_view_create_opportunity_simplified" model="ir.ui.view">
            <field name="name">of.crm.lead.form.simple</field>
            <field name="model">crm.lead</field>
            <field name="inherit_id" ref="crm.view_create_opportunity_simplified"/>
            <field name="arch" type="xml">
                <!-- ##### Full sheet's modification ##### -->
                <xpath expr="//form//sheet" position="replace">
                    <sheet>
                        <field name="stage_probability" invisible="1"/>
                        <!-- Description revenu et probabilite -->
                        <h1>
                            <label string="Description" fonts="bold" class="oe_edit_only" />
                            <field name="name" placeholder="Description du Projet" modifiers="{'required': true}"/>
                        </h1>
                        <h2 class="o_row">
                            <div>
                                <label for="planned_revenue" string="Budget" class="oe_edit_only" />
                                <div class="o_row">
                                    <field name="company_currency" invisible="1"/>
                                    <field name="planned_revenue" widget='monetary' options="{'currency_field': 'company_currency'}"/>
                                    <span class="oe_grey">&#160;à&#160;</span>
                                </div>
                            </div>
                            <div>
                                <label for="probability" class="oe_edit_only"/>
                                <div class="o_row">
                                    <field name="probability" widget="integer"/>
                                    <span>%%</span>
                                </div>
                            </div>
                        </h2>

                        <!-- Corps -->
                        <group col="2">
                            <!-- Prospect group -->
                            <group name='prospect'>
                                <separator string="Prospect" colspan="2"/>
                                <field name="of_check_duplications" invisible="1"/>
                                <field name="partner_id" domain="[('parent_id','=',False)]" context="{'form_view_ref': 'of_crm.res_partner_view_form'}"/>
                                <label for="contact_name" string="Nom du Client"/>
                                <div>
                                    <div class="o_row " >
                                        <field name="contact_name"/>
                                        <field name="title" placeholder="Civilité" domain="[]"
                                          options="{'no_open': True}" can_create="true" can_write="true" modifiers="{}"
                                          attrs="{'invisible': [('contact_name', '=', False)]}"/>
                                    </div>
                                </div>
                                <field name="is_company"/>
                                <label for="street" string="Adresse"/>
                                <div class="o_address_format">
                                    <field name="street" placeholder="Adresse..." class="o_address_street"/>
                                    <field name="street2" placeholder="Adresse suite..." class="o_address_street"/>
                                    <field name="zip_id" options="{'no_open': True, 'no_create': True}" placeholder="City completion" class="oe_edit_only"/>
                                    <field name="city" placeholder="Ville" class="o_address_city"/>
                                    <field name="zip" placeholder="Code postal" class="o_address_zip"/>
                                    <field name="country_id" placeholder="Pays" class="o_address_country" options='{"no_open": True, "no_create": True}'/>
                                </div>
                                <field name="phone" widget="phone" modifiers="{}"/>
                                <field name="mobile" widget="phone" modifiers="{}"/>
                                <field name="email_from" string="Courriel" widget="email" modifiers="{}"/>
                            </group>

                            <!-- Qualification et Suivi group -->
                            <group name='suivi'>
                                <separator string="Qualification et Suivi" colspan="2"/>

                                <field name="of_date_projet"/>
                                <field name="date_deadline"/>
                                <field name="company_id"/>
                                <field name="priority" widget="priority"/>
                                <field name="tag_ids" widget="many2many_tags" options="{'no_create_edit': True}"/>
                                <field name="user_id" domain="[('share', '=', False)]" string="Commercial"
                                  context="{'default_groups_ref': ['base.group_user', 'base.group_partner_manager', 'sales_team.group_sale_salesman_all_leads'], 'team_id': team_id}"/>
                                <field name="of_prospecteur_id"/>
                                <field name="lost_reason" attrs="{'invisible': [('stage_probability', '!=', 0)]}"/>

                                <!-- Invisible champs -->
                                <field name="team_id" invisible="1"/>
                                <field name="date_conversion" invisible="1"/>
                            </group>
                        </group>

                        <!-- Onglets -->
                        <notebook colspan="4">

                            <!-- Notes -->
                            <page string="Notes" >
                                <separator string="Description"/>
                                <field name="description" widget="html"/>
                                <separator string="Autres infos"/>
                                <field name="of_infos_compl" nolabel="1" widget="html"/>
                            </page>

                            <!-- Contact -->
                            <page name="lead" string="Marketing">
                                <group>
                                    <group string="Géolocalisation" name="geoloc" invisible="1">
                                        <field name="geo_lat"/>
                                        <field name="geo_lng"/>
                                    </group>

                                    <group string="Options" name="options" invisible="1">
                                        <!-- option de retrait -->
                                        <field name="opt_out"/>
                                    </group>

                                    <group string="Source" name="source">
                                        <field name="campaign_id" />
                                        <field name="medium_id" string="Canal"/>
                                        <field name="source_id" />
                                    </group>

                                    <group string="Parrainage" name="parrainage">
                                        <field name="of_referred_id" />
                                    </group>

                                    <group string="Dates" name="date">
                                        <field name="of_date_prospection" string="Date de création" />
                                        <field name="write_date" string="Dernières modifications" widget="date" readonly="1"/>
                                    </group>

                                    <group string="Divers" name="Misc">
                                        <field name="of_ref"/>
                                    </group>
                                </group>
                            </page>

                            <!-- Projet -->
                            <page name="project" string="Projet">
                                <group>
                                    <field name="of_modele_id" string="Projet" widget="selection"/>
                                </group>

                                <field name="of_projet_line_ids" nolabel="1" mode="kanban">
                                    <form string="Entrée de Projet">
                                        <sheet>
                                            <group>
                                                <group>
                                                    <field name="name" readonly="1"/>
                                                    <field name="val_bool" readonly="1"
                                                           attrs="{'invisible': [('type','!=','bool')]}"/>
                                                    <field name="val_date" readonly="1"
                                                           attrs="{'invisible': [('type','!=','date')]}"/>
                                                    <field name="val_char" readonly="1"
                                                           attrs="{'invisible': [('type','!=','char')]}"/>
                                                    <field name="val_text" readonly="1"
                                                           attrs="{'invisible': [('type','!=','text')]}"/>
                                                    <field name="val_select_id" widget="selection" readonly="1"
                                                           attrs="{'invisible': [('type','!=','selection')]}"/>
                                                    <field name="answer_date" readonly="1"/>
                                                    <field name="answer_user_id" readonly="1"/>
                                                </group>
                                                <group>
                                                    <field name="answer_orig" readonly="1"/>
                                                    <field name="answer_orig_date" readonly="1"/>
                                                    <field name="answer_orig_user_id" readonly="1"/>
                                                </group>
                                            </group>
                                            <field name="lead_id" invisible="1"/>
                                            <field name="attr_id" invisible="1"/>
                                            <field name="sequence" invisible="1"/>
                                            <field name="type" invisible="1"/>
                                        </sheet>
                                    </form>
                                </field>
                            </page>
                        </notebook>
                        <footer>
                            <button string="Create" name="close_dialog" type="object" class="btn-primary"/>
                            <button string="Discard" class="btn-default" special="cancel"/>
                        </footer>
                    </sheet>
                </xpath>
            </field>
        </record>

        <!--
            crm.lead (as Opportunity) views
        -->
        <record id="of_crm_case_form_view_oppor" model="ir.ui.view">
            <field name="name">of.crm.lead.form.opportunity</field>
            <field name="model">crm.lead</field>
            <field name="inherit_id" ref="crm.crm_case_form_view_oppor"/>
            <field name="arch" type="xml">
                <!-- Modifications header -->
                <!-- Bouton Nouvelle activité -->
                <xpath expr="//button[1]" position="after">
                    <button string="Nouvelle activité" name="%(of_crm_activity_schedule_action)d" type="action" class="oe_highlight"
                        context="{'default_opportunity_id': active_id, 'default_origin': 'opportunity'}"/>
                </xpath>
                <xpath expr="//form//header//button[@type='action'][@class='btn-link'][1]" position="replace"/>
                <xpath expr="//form//header//button[@name='action_set_won']" position="attributes">
                    <attribute name="attrs">{'invisible': [('probability', 'in', (0,100))]}</attribute>
                </xpath>
                <xpath expr="//form//header//button[@type='action'][@class='oe_highlight'][2]" position="attributes">
                    <attribute name="attrs">{'invisible': [('probability', 'in', (0,100))]}</attribute>
                </xpath>
                <!-- ##### Full sheet's modification ##### -->
                <xpath expr="//form//sheet" position="replace">
                    <sheet>
                        <group name="title_and_buttons" >
                            <div class="oe_title of_width_200" >
                                <!-- Étiquettes Gagné/Perdu (vues conditionnelles) -->
                                <field name="stage_probability" invisible="1"/>
                                <div class="label label-danger pull-right" attrs="{'invisible': [('stage_probability', '&gt;', 0)]}" >Perdu</div>
                                <div class="label label-info pull-right" attrs="{'invisible': [('stage_probability', '&lt;', 100)]}" >Gagné</div>

                                <!-- Titre -->
                                <separator string="Opportunité"  />
                            </div>

                            <!-- Boutons -->
                            <div class="oe_button_box of_width_600" name="button_box_custom" >
                                <!-- Bouton Actif -->
                                <button name="toggle_active" type="object" class="oe_stat_button" icon="fa-archive" display="inline-block">
                                    <field name="active" widget="boolean_button" options='{"terminology": "archive"}'/>
                                </button>

                                <!-- Bouton Reunion  -->
                                <button class="oe_stat_button" type="object" display="inline-block"
                                  context="{'partner_id': partner_id}"
                                  name="action_schedule_meeting" icon="fa-calendar">
                                    <div class="o_stat_info">
                                        <field name="meeting_count" class="o_stat_value"/>
                                        <span class="o_stat_text" attrs="{'invisible': [('meeting_count', '&lt;', 2)]}"> Réunions</span>
                                        <span class="o_stat_text" attrs="{'invisible': [('meeting_count', '&gt;', 1)]}"> Réunion</span>
                                    </div>
                                </button>

                                <!-- Bouton Devis -->
                                <button class="oe_stat_button" type="action" display="inline-block"
                                  name="%(sale_crm.sale_action_quotations)d" icon="fa-pencil-square-o"
                                  context="{'default_partner_id': partner_id, 'search_default_draft': 1}">
                                    <div class="o_stat_info">
                                        <field name="sale_number" class="o_stat_value" modifiers="{'readonly': true}"/>
                                        <span class="o_stat_text"> Devis</span>
                                    </div>
                                </button>

                                <!-- Bouton Ordres (vue conditionnelle) -->
                                <button class="oe_stat_button" type="action" display="inline-block"
                                  attrs="{'invisible': [('sale_amount_total', '=', 0)]}" name="%(sale_crm.sale_action_quotations)d" icon="fa-usd"
                                  context="{'search_default_partner_id': partner_id, 'default_partner_id': partner_id, 'search_default_sales': 1}"
                                  modifiers="{'invisible': [['sale_amount_total', '=', 0]]}">
                                    <div class="o_form_field o_stat_info">
                                        <span class="o_stat_value">
                                            <field name="sale_amount_total" widget="monetary"
                                              options="{'currency_field': 'company_currency'}" modifiers="{'readonly': true}"/>
                                        </span>
                                        <span class="o_stat_text"> Ordres</span>
                                    </div>
                                </button>

                                <!-- Bouton RDV Techs -->
                                <button class="oe_stat_button" name="action_view_interventions" type="object" icon="fa-calendar">
                                    <field string="RDV(s) Tech" name="of_intervention_count" widget="statinfo"/>
                                </button>
                            </div>
                        </group>

                        <!-- Description revenu et probabilite -->
                        <h1 style="margin-top: -20px !important;">
                            <label string="Description" fonts="bold" class="oe_edit_only"/>
                            <field name="name" placeholder="Description du Projet" modifiers="{'required': true}"/>
                        </h1>
                        <h2 class="o_row">
                            <div>
                                <label for="planned_revenue" string="Budget" class="oe_edit_only" />
                                <div class="o_row">
                                    <field name="company_currency" invisible="1"/>
                                    <field name="planned_revenue" widget='monetary' options="{'currency_field': 'company_currency'}"/>
                                    <span class="oe_grey">&#160;à&#160;</span>
                                </div>
                            </div>
                            <div>
                                <label for="probability" class="oe_edit_only"/>
                                <div class="o_row">
                                    <field name="probability" widget="integer"/>
                                    <span>%%</span>
                                </div>
                            </div>
                        </h2>

                        <!-- Corps -->
                        <group col="2">
                            <!-- Prospect group -->
                            <group name='prospect'>
                                <separator string="Prospect" colspan="2"/>
                                <field name="of_check_duplications" invisible="1"/>
                                <field name="partner_id" domain="[('parent_id','=',False)]" context="{'form_view_ref': 'of_crm.res_partner_view_form'}"/>
                                <label for="contact_name" string="Nom du Client"/>
                                <div>
                                    <div class="o_row " >
                                        <field name="contact_name"/>
                                        <field name="title" placeholder="Civilité" domain="[]"
                                               options="{'no_open': True}" can_create="true" can_write="true" modifiers="{}"
                                               attrs="{'invisible': [('contact_name', '=', False)]}"/>
                                    </div>
                                </div>
                                <field name="is_company"/>
                                <label for="street" string="Adresse"/>
                                <div class="o_address_format">
                                    <field name="street" placeholder="Adresse..." class="o_address_street"/>
                                    <field name="street2" placeholder="Adresse suite..." class="o_address_street"/>
                                    <field name="zip_id" options="{'no_open': True, 'no_create': True}" placeholder="City completion" class="oe_edit_only"/>
                                    <field name="city" placeholder="Ville" class="o_address_city"/>
                                    <field name="zip" placeholder="Code postal" class="o_address_zip"/>
                                    <field name="country_id" placeholder="Pays" class="o_address_country" options='{"no_open": True, "no_create": True}'/>
                                </div>
                                <field name="phone" widget="phone" modifiers="{}"/>
                                <field name="mobile" widget="phone" modifiers="{}"/>
                                <field name="email_from" string="Courriel" widget="email" modifiers="{}"/>
                            </group>

                            <!-- Qualification et Suivi group -->
                            <group name='suivi'>
                                <separator string="Qualification et Suivi" colspan="2"/>

                                <field name="of_date_projet"/>
                                <field name="date_deadline"/>
                                <field name="company_id"/>
                                <field name="priority" widget="priority"/>
                                <field name="tag_ids" widget="many2many_tags" options="{'no_create_edit': True}"/>
                                <field name="user_id" domain="[('share', '=', False)]" string="Commercial"
                                  context="{'default_groups_ref': ['base.group_user', 'base.group_partner_manager', 'sales_team.group_sale_salesman_all_leads'], 'team_id': team_id}"/>
                                <field name="of_prospecteur_id"/>
                                <field name="lost_reason" attrs="{'invisible': [('stage_probability', '!=', 0)]}"/>

                                <!-- Invisible champs -->
                                <field name="team_id" invisible="1"/>
                                <field name="date_conversion" invisible="1"/>
                            </group>
                        </group>

                        <!-- Onglets -->
                        <notebook colspan="4">

                            <!-- Activités -->
                            <page string="Activités">
                                <field name="of_activity_ids"
                                       context="{'default_opportunity_id': active_id,
                                       'default_origin': 'opportunity',
                                       'close_and_reload': True,
                                       'form_view_ref':'of_crm.of_crm_activity_from_opportunity_form_view'}">
                                    <tree decoration-muted="state=='canceled' or not active" decoration-danger="is_late">
                                        <field name="origin" invisible="1"/>
                                        <field name="is_late" invisible="1"/>
                                        <field name="active" invisible="1"/>
                                        <field name="load_attachment" invisible="1"/>
                                        <field name="uploaded_attachment_id" invisible="1"/>
                                        <field name="title"/>
                                        <field name="type_id"/>
                                        <field name="date"/>
                                        <field name="user_id"/>
                                        <field name="vendor_id"/>
                                        <field name="state"/>
                                        <button name="action_add_attachment" icon="fa-upload" type="object" string="Add attachments"
                                                attrs="{'invisible': ['|', ('load_attachment', '=', False), ('uploaded_attachment_id', '!=', False)]}"/>
                                        <button name="action_complete" type="object" string="Réaliser" icon="fa-check"
                                                attrs="{'invisible': [('state', '!=', 'planned')]}"/>
                                        <button name="action_cancel" type="object" string="Annuler" icon="fa-close"
                                                attrs="{'invisible': [('state', '!=', 'planned')]}"/>
                                    </tree>
                                </field>
                            </page>

                            <!-- Contact -->
                            <page name="lead" string="Marketing">
                                <group>
                                    <group string="Géolocalisation" name="geoloc" invisible="1">
                                        <field name="geo_lat"/>
                                        <field name="geo_lng"/>
                                        <field name="precision"/>
                                    </group>

                                    <group string="Options" name="options" invisible="1">
                                        <!-- option de retrait -->
                                        <field name="opt_out"/>
                                    </group>

                                    <group string="Source" name="source">
                                        <field name="campaign_id" />
                                        <field name="medium_id" string="Canal"/>
                                        <field name="source_id" />
                                    </group>

                                    <group string="Parrainage" name="parrainage">
                                        <field name="of_referred_id" />
                                    </group>

                                    <group string="Dates" name="date">
                                        <field name="of_date_prospection" string="Date de création" />
                                        <field name="write_date" string="Dernières modifications" widget="date" readonly="1"/>
                                    </group>

                                    <group string="Divers" name="Misc">
                                        <field name="of_ref"/>
                                    </group>
                                </group>
                            </page>

                            <!-- Projet -->
                            <page name="project" string="Projet">
                                <group>
                                    <field name="of_modele_id" string="Projet" widget="selection"/>
                                </group>

                                <!--label for="of_projet_line_ids"/-->
                                <field name="of_projet_line_ids" nolabel="1" mode="kanban">
                                    <form string="Entrée de Projet">
                                        <sheet>
                                            <group>
                                                <group>
                                                    <field name="name" readonly="1"/>
                                                    <field name="val_bool" readonly="1"
                                                           attrs="{'invisible': [('type','!=','bool')]}"/>
                                                    <field name="val_date" readonly="1"
                                                           attrs="{'invisible': [('type','!=','date')]}"/>
                                                    <field name="val_char" readonly="1"
                                                           attrs="{'invisible': [('type','!=','char')]}"/>
                                                    <field name="val_text" readonly="1"
                                                           attrs="{'invisible': [('type','!=','text')]}"/>
                                                    <field name="val_select_id" widget="selection" readonly="1"
                                                           attrs="{'invisible': [('type','!=','selection')]}"/>
                                                    <field name="answer_date" readonly="1"/>
                                                    <field name="answer_user_id" readonly="1"/>
                                                </group>
                                                <group>
                                                    <field name="answer_orig" readonly="1"/>
                                                    <field name="answer_orig_date" readonly="1"/>
                                                    <field name="answer_orig_user_id" readonly="1"/>
                                                </group>
                                            </group>
                                            <field name="lead_id" invisible="1"/>
                                            <field name="attr_id" invisible="1"/>
                                            <field name="sequence" invisible="1"/>
                                            <field name="type" invisible="1"/>
                                        </sheet>
                                    </form>
                                </field>
                            </page>

                            <!-- Notes -->
                            <page string="Notes" >
                                <separator string="Description"/>
                                <field name="description" widget="html"/>
                                <separator string="Autres infos"/>
                                <field name="of_infos_compl" nolabel="1" widget="html"/>
                            </page>
                        </notebook>
                    </sheet>
                <!--/form-->
                </xpath>
            </field>
        </record>

        <!-- vue liste des opportunités -->
        <record id="of_crm_case_tree_view_oppor" model="ir.ui.view">
            <field name="name">crm.lead.tree.opportunity</field>
            <field name="model">crm.lead</field>
            <field name="inherit_id" ref="crm.crm_case_tree_view_oppor"/>
            <field name="arch" type="xml">
                <tree position="attributes">
                    <attribute name="decoration-danger">of_date_action and (of_date_action &lt; current_date)</attribute>
                </tree>
                <!-- Retrait des affichages pays et équipe commerciale -->
                <xpath expr="//tree//field[@name='country_id']" position="attributes">
                    <attribute name="invisible">1</attribute>
                </xpath>
                <xpath expr="//tree//field[@name='team_id']" position="attributes">
                    <attribute name="invisible">1</attribute>
                </xpath>
                <!-- Simplification des titres -->
                <xpath expr="//tree//field[@name='create_date']" position="attributes">
                    <attribute name="string">Date</attribute>
                </xpath>
                <xpath expr="//tree//field[@name='date_action']" position="replace">
                    <field name="of_date_action"/>
                </xpath>
                <xpath expr="//tree//field[@name='title_action']" position="replace">
                    <field name="of_title_action"/>
                </xpath>
            </field>
        </record>

        <!-- vue liste des prochaines activités -->
        <record id="of_crm_lead_view_tree_activity" model="ir.ui.view">
            <field name="name">of.crm.lead.tree.opportunity.next.activity</field>
            <field name="model">crm.lead</field>
            <field name="inherit_id" ref="crm.crm_lead_view_tree_activity"/>
            <field name="arch" type="xml">
                <!-- changement des noms de colonnes -->
                <xpath expr="//tree//field[@name='date_action']" position="attributes">
                    <attribute name="string">Date</attribute>
                </xpath>
                <xpath expr="//tree//field[@name='next_activity_id']" position="attributes">
                    <attribute name="string">Activité</attribute>
                </xpath>
                <xpath expr="//tree//field[@name='title_action']" position="attributes">
                    <attribute name="string">Résumé</attribute>
                </xpath>
                <xpath expr="//tree//field[@name='planned_revenue']" position="attributes">
                    <attribute name="string">Budget</attribute>
                </xpath>
                <xpath expr="//tree//field[@name='date_deadline']" position="attributes">
                    <attribute name="string">Date Projet</attribute>
                </xpath>
            </field>
        </record>

        <record id="of_view_crm_case_opportunities_filter" model="ir.ui.view">
            <field name="name">of.crm.lead.search - Opportunities</field>
            <field name="model">crm.lead</field>
            <field name="inherit_id" ref="crm.view_crm_case_opportunities_filter"/>
            <field name="arch" type="xml">
                <field name="name" position="after">
                    <field name="zip"/>
                    <field name="contact_name"/>
                    <field name="of_projet_line_ids" string="Projet"/>
                    <!-- on utilise le champ 'name' car il nous fallait un champ texte -->
                    <field name="name" string="Marque" filter_domain="[('of_projet_line_ids','ilike','Marque:'+self)]"/>
                    <field name="company_id"/>
                </field>
                <xpath expr="//filter[@name='message_needaction']" position="before">
                    <filter string="Créé cette semaine" name="create_this_week"
                            domain="[('create_date', '>=', (context_today() - datetime.timedelta(days=context_today().weekday())).strftime('%Y-%m-%d'))]"/>
                    <filter string="Modifié cette semaine" name="write_this_week"
                            domain="[('write_date', '>=', (context_today() - datetime.timedelta(days=context_today().weekday())).strftime('%Y-%m-%d'))]"/>
                    <separator/>
                </xpath>
                <xpath expr="//filter[@name='today']" position="replace">
                    <filter string="Today Activities" name="today"
                            domain="[('of_date_action_filter', '=', context_today().strftime('%Y-%m-%d'))]"/>
                </xpath>
                <xpath expr="//filter[@name='this_week']" position="replace">
                    <filter string="This Week Activities To Do" name="this_week"
                        domain="[('of_date_action_filter', '&gt;=', (context_today() - datetime.timedelta(days=context_today().weekday())).strftime('%Y-%m-%d')),
                                 ('of_date_action_filter', '&lt;', (context_today() + datetime.timedelta(days=7-context_today().weekday())).strftime('%Y-%m-%d'))]"/>
                </xpath>
                <xpath expr="//filter[@name='overdue']" position="replace">
                    <filter string="Overdue Activities" name="overdue"
                        domain="[('of_date_action_filter', '&lt;', context_today().strftime('%Y-%m-%d'))]"
                        help="Show all opportunities for which the next action date is before today"/>
                </xpath>
            </field>
        </record>

        <!-- delete model="ir.ui.menu" id="crm.menu_crm_lead_categ"/>  -->

        <record id="of_crm_stage_form" model="ir.ui.view">
            <field name="name">of.crm.stage.form</field>
            <field name="model">crm.stage</field>
            <field name="inherit_id" ref="crm.crm_stage_form"/>
            <field name="priority" eval="1"/>
            <field name="arch" type="xml">
                <!-- rendre la probabilité toujours visible-->
                <xpath expr="//form//field[@name='probability']" position="attributes">
                    <attribute name="attrs"></attribute>
                </xpath>
                <field name="requirements" position="after">
                    <group groups="of_base.of_group_root_only">
                        <separator string="Automatisation de l'étape" colspan="4"/>
                        <group>
                            <field name="of_auto_model_name"/>
                            <field name="of_auto_field_id" options="{'no_create': True, 'no_open': True}"
                                   domain="[('model', '=', of_auto_model_name), ('store', '=', True)]"
                                   attrs="{'required': [('of_auto_model_name', '!=', False)]}"
                            />
                            <field name="of_auto_comparison_code"
                                   attrs="{'required': [('of_auto_model_name', '!=', False)]}"/>
                        </group>
                        <group>
                            <field name="of_manual_activity_id"/>
                        </group>
                    </group>
                </field>
            </field>
        </record>

        <!-- ########## Ajout vue map ########## -->

        <record id="of_crm_map_view" model="ir.ui.view">
            <field name="name">of.crm.map</field>
            <field name="model">crm.lead</field>
            <field name="arch" type="xml">
                <map string="Map" class="o_crm_lead_map" latitude_field="geo_lat" longitude_field="geo_lng" color_field="of_color_map">
                    <field name="active" invisible="1"/>
                    <field name="of_color_map" required="1"/>
                    <field name="geo_lat" required="1"/>
                    <field name="geo_lng" required="1"/>
                    <field name="precision"/>
                    <field name="id"/>
                    <field name="name"/>
                    <field name="contact_name"/>
                    <field name="zip"/>
                    <field name="city"/>
                    <field name="phone"/>
                    <field name="mobile"/>
                    <field name="next_activity_name"/>
                    <field name="date_action"/>
                    <field name="tag_ids"/>
                    <templates>
                        <t t-name="of_map_record_box">
                            <div t-attf-class="#{map_record_color(record.of_color_map.raw_value)} of_map_record_global_click">
                                <div class="of_map_record_buttons">
                                    <i class="of_map_record_close fa fa-lg fa-times"/>
                                    <!--i class="of_map_record_min fa fa-lg fa-minus"/>  later implementation...
                                    <i class="of_map_record_max fa fa-lg fa-square"/-->
                                </div>
                                <div name="content" class="of_map_record_content">
                                    <t t-if="record.name.raw_value != record.partner_name.raw_value">
                                        <strong><field name="name"/></strong><br/>
                                    </t>
                                    <t t-if="record.partner_name.raw_value">
                                        <i class="fa fa-user"/><span class="of_ws"/>
                                        <strong><field name="partner_name"/></strong><br/>
                                    </t>
                                    <t t-if="record.city.raw_value">
                                        <i class="fa fa-map-marker"/><span class="of_ws"/>
                                        <field name="zip"/><span class="of_ws"/>
                                        <field name="city"/><br/>
                                    </t>
                                    <t t-if="record.phone.raw_value">
                                        <i class="fa fa-phone"/><span class="of_ws"/>
                                        <field name="phone"/><br/>
                                    </t>
                                    <t t-if="record.mobile.raw_value">
                                        <i class="fa fa-phone"/><span class="of_ws"/>
                                        <field name="mobile"/><br/>
                                    </t>
                                    <t t-if="record.date_action.raw_value">
                                        <i class="fa fa-calendar-o"/><span class="of_ws"/>
                                        <field name="next_activity_name"/><span class="of_ws"/>
                                        <field name="date_action"/><br/>
                                    </t>
                                    <t t-if="record.tag_ids.raw_value">
                                        <field name="tag_ids" of_options='{"exclude_vals": ["client","prospect"]}'/>
                                    </t>
                                </div>
                            </div>
                        </t>
                        <t t-name="of_map_marker_tooltip">
                            <div name="marker_tooltip">
                                <field name="name"/><br/>
                                Précision:
                                <t t-if='["manual","high","medium","low"].includes(record.precision.raw_value)'>
                                    <field name="precision"/>
                                </t>
                                <t t-else="">
                                    <span class="of_ws"/>
                                    Indeterminée
                                </t>
                            </div>
                        </t>
                    </templates>
                </map>
            </field>
        </record>

        <!-- Ajout vue map. Cette action est utilisée quand l'utilisateur rafraîchit la page 'votre pipeline' -->
        <record model="ir.actions.act_window" id="crm.crm_lead_opportunities_tree_view">
            <field name="view_mode">kanban,tree,graph,pivot,form,calendar,map</field>
            <field name="view_ids"
                   eval="[(5, 0, 0),
                          (0, 0, {'view_mode': 'kanban', 'view_id': ref('crm.crm_case_kanban_view_leads')}),
                          (0, 0, {'view_mode': 'tree', 'view_id': ref('crm.crm_case_tree_view_oppor')}),
                          (0, 0, {'view_mode': 'map', 'view_id': ref('of_crm_map_view')}),
                          (0, 0, {'view_mode': 'form', 'view_id': ref('crm.crm_case_form_view_oppor')}),
                          (0, 0, {'view_mode': 'calendar'}),
                          (0, 0, {'view_mode': 'pivot'}),
                          (0, 0, {'view_mode': 'graph'})]"/>
            <field name="context">{
                    'default_type': 'opportunity',
                    'default_user_id': uid,
            }</field>
        </record>

        <!-- CRM Team view -->
        <record id="of_crm_team_kanban_view" model="ir.ui.view">
            <field name="name">of.crm.team.kanban.view</field>
            <field name="model">crm.team</field>
            <field name="inherit_id" ref="crm.crm_team_salesteams_view_kanban"/>
            <field name="arch" type="xml">
                <xpath expr="//a[@name='%(crm.crm_activity_report_action_team)d']" position="replace">
                    <a name="%(of_crm.of_crm_funnel_conversion2_action)d" type="action">Analyse des activités</a>
                </xpath>
            </field>
        </record>

        <record id="crm.crm_activity_action" model="ir.actions.act_window">
            <field name="name">Activity types</field>
        </record>

        <!-- Menus -->

        <record id="crm.crm_lead_menu_activities" model="ir.ui.menu">
            <field name="groups_id" eval="[(6, 0, [ref('of_base.of_group_hidden')])]"/>
        </record>

        <record id="crm.crm_activity_report_menu" model="ir.ui.menu">
            <field name="groups_id" eval="[(6, 0, [ref('of_base.of_group_hidden')])]"/>
        </record>

        <menuitem id="of_crm_crm_menu" name="CRM" parent="sales_team.menu_base_partner" sequence="3"/>

        <record id="crm.menu_crm_opportunities" model="ir.ui.menu">
            <field name="parent_id" ref="of_crm.of_crm_crm_menu"/>
            <field name="sequence" eval="20"/>
        </record>

        <record id="crm.crm_activity_menu" model="ir.ui.menu">
            <field name="name">Activity types</field>
        </record>

        <menuitem id="of_crm_activity_menu" name="Activities" parent="of_crm.of_crm_crm_menu" sequence="30" action="of_crm_activity_action"/>
        <menuitem id="of_crm_activity_sale_menu" name="Activities" action="of_crm_activity_sale_action" parent="sales_team.menu_sales" sequence="15"/>


<!-- #######################################################################################
                                      CALENDAR EVENT
############################################################################################ -->

        <record id="of_view_calendar_event_form_crm" model="ir.ui.view">
            <field name="name">of.calendar.event.form.crm</field>
            <field name="model">calendar.event</field>
            <field name="inherit_id" ref="of_calendar.of_view_calendar_event_form"/>
            <field name="arch" type="xml">
                <xpath expr="//field[@name='user_id']" position="after">
                    <field name="opportunity_id"/>
                </xpath>
            </field>
        </record>

</odoo>
